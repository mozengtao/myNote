# initcall æœºåˆ¶ä¸­çš„ä¾èµ–æ³¨å…¥æ¨¡å¼

> æ–‡ä»¶è·¯å¾„: `/tmp/linux-ioc-patterns/05_initcall_mechanism.md`
> å†…æ ¸ç‰ˆæœ¬: Linux 3.2
> éš¾åº¦: â­â­

---

## 1. æ¨¡å¼æ¦‚è¿°

initcall æœºåˆ¶æ˜¯ Linux å†…æ ¸ä¸­ç‹¬ç‰¹çš„**ç¼–è¯‘æ—¶ä¾èµ–æ³¨å…¥**ã€‚å„æ¨¡å—é€šè¿‡å®å°†åˆå§‹åŒ–å‡½æ•°"æ³¨å†Œ"åˆ°ç‰¹å®šçš„é“¾æ¥å™¨èŠ‚åŒº (section)ï¼Œå†…æ ¸å¯åŠ¨æ—¶æ¡†æ¶è‡ªåŠ¨æŒ‰é¡ºåºéå†å¹¶è°ƒç”¨è¿™äº›å‡½æ•°ã€‚

### DI/IoC çš„å…·ä½“è¡¨ç°å½¢å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        initcall æœºåˆ¶çš„ä¾èµ–æ³¨å…¥                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   ç¼–è¯‘æ—¶: å„æ¨¡å—é€šè¿‡å®å£°æ˜åˆå§‹åŒ–å‡½æ•°                                         â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚   net/ipv4/af_inet.c           drivers/pci/pci.c                     â”‚  â”‚
â”‚   â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                     â”‚  â”‚
â”‚   â”‚                                                                       â”‚  â”‚
â”‚   â”‚   static int __init            static int __init                     â”‚  â”‚
â”‚   â”‚   inet_init(void) { ... }      pci_init(void) { ... }                â”‚  â”‚
â”‚   â”‚                                                                       â”‚  â”‚
â”‚   â”‚   fs_initcall(inet_init);      postcore_initcall(pci_init);          â”‚  â”‚
â”‚   â”‚            â”‚                              â”‚                           â”‚  â”‚
â”‚   â”‚            â”‚  å®å±•å¼€                       â”‚  å®å±•å¼€                   â”‚  â”‚
â”‚   â”‚            â–¼                              â–¼                           â”‚  â”‚
â”‚   â”‚   static initcall_t            static initcall_t                     â”‚  â”‚
â”‚   â”‚   __initcall_inet_init5        __initcall_pci_init2                  â”‚  â”‚
â”‚   â”‚   __section(.initcall5.init)   __section(.initcall2.init)            â”‚  â”‚
â”‚   â”‚   = inet_init;                 = pci_init;                            â”‚  â”‚
â”‚   â”‚                                                                       â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚   é“¾æ¥æ—¶: é“¾æ¥å™¨å°†å‡½æ•°æŒ‡é’ˆæŒ‰ section æ’åº                                    â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                        vmlinux å¯æ‰§è¡Œæ–‡ä»¶                             â”‚  â”‚
â”‚   â”‚                                                                       â”‚  â”‚
â”‚   â”‚   .initcall1.init:  [ mm_init, ... ]        (core_initcall)          â”‚  â”‚
â”‚   â”‚   .initcall2.init:  [ pci_init, ... ]       (postcore_initcall)      â”‚  â”‚
â”‚   â”‚   .initcall3.init:  [ ... ]                 (arch_initcall)          â”‚  â”‚
â”‚   â”‚   .initcall4.init:  [ ... ]                 (subsys_initcall)        â”‚  â”‚
â”‚   â”‚   .initcall5.init:  [ inet_init, ... ]      (fs_initcall)            â”‚  â”‚
â”‚   â”‚   .initcall6.init:  [ ... ]                 (device_initcall)        â”‚  â”‚
â”‚   â”‚   .initcall7.init:  [ ... ]                 (late_initcall)          â”‚  â”‚
â”‚   â”‚                                                                       â”‚  â”‚
â”‚   â”‚   __initcall_start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º __initcall_end            â”‚  â”‚
â”‚   â”‚                                                                       â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚   è¿è¡Œæ—¶: æ¡†æ¶éå†å¹¶è°ƒç”¨æ‰€æœ‰ initcall                                        â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚   do_initcalls() @ init/main.c                                       â”‚  â”‚
â”‚   â”‚                                                                       â”‚  â”‚
â”‚   â”‚   for (fn = __initcall_start; fn < __initcall_end; fn++)             â”‚  â”‚
â”‚   â”‚       do_one_initcall(*fn);   â—„â”€â”€ æ¡†æ¶æ§åˆ¶è°ƒç”¨é¡ºåºå’Œæ—¶æœº             â”‚  â”‚
â”‚   â”‚                                                                       â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚   æ§åˆ¶åè½¬:                                                                  â”‚
â”‚   â€¢ æ¨¡å—ä¸å†³å®šä½•æ—¶åˆå§‹åŒ– â†’ ç”±æ¡†æ¶å†³å®š                                       â”‚
â”‚   â€¢ æ¨¡å—ä¸å†³å®šåˆå§‹åŒ–é¡ºåº â†’ ç”± initcall çº§åˆ«å†³å®š                            â”‚
â”‚   â€¢ æ¨¡å—åªéœ€å£°æ˜åˆå§‹åŒ–å‡½æ•°ï¼Œæ¡†æ¶è´Ÿè´£è°ƒç”¨                                    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. è®¾è®¡åŠ¨æœº

### è¦è§£å†³çš„é—®é¢˜

| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|------|----------|
| **æ¨¡å—åˆå§‹åŒ–é¡ºåº** | é€šè¿‡ä¸åŒçº§åˆ«çš„ initcall æ§åˆ¶ |
| **æ¨¡å—é—´ä¾èµ–** | ä¾èµ–æ–¹ä½¿ç”¨æ›´é«˜çº§åˆ«çš„ initcall |
| **ä»£ç è§£è€¦** | æ¨¡å—ä¸éœ€è¦çŸ¥é“è°è°ƒç”¨å®ƒçš„åˆå§‹åŒ–å‡½æ•° |
| **ç¼–è¯‘é…ç½®çµæ´»** | æ¨¡å—å¯ä»¥ç¼–è¯‘è¿›å†…æ ¸æˆ–ä½œä¸ºæ¨¡å—åŠ è½½ |
| **åˆå§‹åŒ–å†…å­˜å›æ”¶** | `__init` æ ‡è®°çš„ä»£ç å¯ä»¥åœ¨å¯åŠ¨åé‡Šæ”¾ |

### è®¾è®¡ç›®æ ‡

1. **è‡ªåŠ¨åŒ–**: æ— éœ€ä¸­å¤®æ³¨å†Œè¡¨ï¼Œè‡ªåŠ¨æ”¶é›†æ‰€æœ‰åˆå§‹åŒ–å‡½æ•°
2. **é¡ºåºå¯æ§**: é€šè¿‡çº§åˆ«æ§åˆ¶åˆå§‹åŒ–é¡ºåº
3. **é›¶è¿è¡Œæ—¶å¼€é”€**: ç¼–è¯‘æ—¶ç¡®å®šï¼Œè¿è¡Œæ—¶åªæ˜¯éå†æ•°ç»„
4. **å†…å­˜æ•ˆç‡**: åˆå§‹åŒ–å®Œæˆåå¯ä»¥é‡Šæ”¾åˆå§‹åŒ–ä»£ç 

---

## 3. æ ¸å¿ƒæ•°æ®ç»“æ„

### 3.1 initcall å®å®šä¹‰

```c
// include/linux/init.h (ç¬¬ 138-210 è¡Œ)

// åˆå§‹åŒ–å‡½æ•°æŒ‡é’ˆç±»å‹
typedef int (*initcall_t)(void);
typedef void (*exitcall_t)(void);

// æ ¸å¿ƒå®: å°†å‡½æ•°æŒ‡é’ˆæ”¾å…¥æŒ‡å®šçš„é“¾æ¥å™¨èŠ‚åŒº
#define __define_initcall(level, fn, id) \
    static initcall_t __initcall_##fn##id __used \
    __attribute__((__section__(".initcall" level ".init"))) = fn

// ä¸åŒçº§åˆ«çš„ initcall (æŒ‰æ‰§è¡Œé¡ºåº)
//
// çº§åˆ«    å®å                      section å           ç”¨é€”
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// early   early_initcall(fn)       .initcallearly.init   SMP å‰
// 0       pure_initcall(fn)        .initcall0.init       çº¯åˆå§‹åŒ–
// 1       core_initcall(fn)        .initcall1.init       æ ¸å¿ƒå­ç³»ç»Ÿ
// 1s      core_initcall_sync(fn)   .initcall1s.init      æ ¸å¿ƒåŒæ­¥
// 2       postcore_initcall(fn)    .initcall2.init       æ ¸å¿ƒå
// 2s      postcore_initcall_sync(fn).initcall2s.init     æ ¸å¿ƒååŒæ­¥
// 3       arch_initcall(fn)        .initcall3.init       æ¶æ„ç›¸å…³
// 3s      arch_initcall_sync(fn)   .initcall3s.init      æ¶æ„åŒæ­¥
// 4       subsys_initcall(fn)      .initcall4.init       å­ç³»ç»Ÿ
// 4s      subsys_initcall_sync(fn) .initcall4s.init      å­ç³»ç»ŸåŒæ­¥
// 5       fs_initcall(fn)          .initcall5.init       æ–‡ä»¶ç³»ç»Ÿ
// 5s      fs_initcall_sync(fn)     .initcall5s.init      æ–‡ä»¶ç³»ç»ŸåŒæ­¥
// rootfs  rootfs_initcall(fn)      .initcallrootfs.init  æ ¹æ–‡ä»¶ç³»ç»Ÿ
// 6       device_initcall(fn)      .initcall6.init       è®¾å¤‡é©±åŠ¨
// 6s      device_initcall_sync(fn) .initcall6s.init      è®¾å¤‡åŒæ­¥
// 7       late_initcall(fn)        .initcall7.init       æœ€å
// 7s      late_initcall_sync(fn)   .initcall7s.init      æœ€ååŒæ­¥

#define early_initcall(fn)          __define_initcall("early", fn, early)
#define pure_initcall(fn)           __define_initcall("0", fn, 0)
#define core_initcall(fn)           __define_initcall("1", fn, 1)
#define core_initcall_sync(fn)      __define_initcall("1s", fn, 1s)
#define postcore_initcall(fn)       __define_initcall("2", fn, 2)
#define postcore_initcall_sync(fn)  __define_initcall("2s", fn, 2s)
#define arch_initcall(fn)           __define_initcall("3", fn, 3)
#define arch_initcall_sync(fn)      __define_initcall("3s", fn, 3s)
#define subsys_initcall(fn)         __define_initcall("4", fn, 4)
#define subsys_initcall_sync(fn)    __define_initcall("4s", fn, 4s)
#define fs_initcall(fn)             __define_initcall("5", fn, 5)
#define fs_initcall_sync(fn)        __define_initcall("5s", fn, 5s)
#define rootfs_initcall(fn)         __define_initcall("rootfs", fn, rootfs)
#define device_initcall(fn)         __define_initcall("6", fn, 6)
#define device_initcall_sync(fn)    __define_initcall("6s", fn, 6s)
#define late_initcall(fn)           __define_initcall("7", fn, 7)
#define late_initcall_sync(fn)      __define_initcall("7s", fn, 7s)

// module_init é»˜è®¤ç­‰äº device_initcall
#define __initcall(fn) device_initcall(fn)

// é™æ€ç¼–è¯‘æ—¶
#define module_init(x)  __initcall(x);
#define module_exit(x)  __exitcall(x);
```

### 3.2 é“¾æ¥å™¨è„šæœ¬å®šä¹‰

```c
// include/asm-generic/vmlinux.lds.h (ç¬¬ 600-650 è¡Œ)

#define INIT_CALLS_LEVEL(level)                             \
    VMLINUX_SYMBOL(__initcall##level##_start) = .;         \
    *(.initcall##level##.init)                              \
    *(.initcall##level##s.init)

#define INIT_CALLS                                          \
    VMLINUX_SYMBOL(__initcall_start) = .;                  \
    *(.initcallearly.init)                                  \
    INIT_CALLS_LEVEL(0)                                     \
    INIT_CALLS_LEVEL(1)                                     \
    INIT_CALLS_LEVEL(2)                                     \
    INIT_CALLS_LEVEL(3)                                     \
    INIT_CALLS_LEVEL(4)                                     \
    INIT_CALLS_LEVEL(5)                                     \
    *(.initcallrootfs.init)                                 \
    INIT_CALLS_LEVEL(6)                                     \
    INIT_CALLS_LEVEL(7)                                     \
    VMLINUX_SYMBOL(__initcall_end) = .;
```

### 3.3 å†…å­˜å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        initcall åœ¨å†…å­˜ä¸­çš„å¸ƒå±€                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   vmlinux å†…å­˜å¸ƒå±€ (ç®€åŒ–)                                                    â”‚
â”‚                                                                              â”‚
â”‚   ä½åœ°å€                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                           .text                                      â”‚   â”‚
â”‚   â”‚                         (å†…æ ¸ä»£ç )                                   â”‚   â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚   â”‚                           .data                                      â”‚   â”‚
â”‚   â”‚                         (å·²åˆå§‹åŒ–æ•°æ®)                               â”‚   â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚   â”‚                           .bss                                       â”‚   â”‚
â”‚   â”‚                         (æœªåˆå§‹åŒ–æ•°æ®)                               â”‚   â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â”‚   .init èŠ‚åŒº (å¯åŠ¨åå¯é‡Šæ”¾)                                          â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚   â”‚   â”‚                      .init.text                               â”‚  â”‚   â”‚
â”‚   â”‚   â”‚                  (æ ‡è®° __init çš„å‡½æ•°)                         â”‚  â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚   â”‚
â”‚   â”‚   â”‚                      .init.data                               â”‚  â”‚   â”‚
â”‚   â”‚   â”‚                  (æ ‡è®° __initdata çš„æ•°æ®)                     â”‚  â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚   â”‚
â”‚   â”‚   â”‚                                                               â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   initcall æ•°ç»„                                               â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   â”‚ __initcall_start:                                     â”‚  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   â”‚                                                        â”‚  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   â”‚ .initcallearly.init:                                  â”‚  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   â”‚   [ early_fn1, early_fn2, ... ]                       â”‚  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   â”‚                                                        â”‚  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   â”‚ .initcall0.init: (pure)                               â”‚  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   â”‚   [ pure_fn1, ... ]                                   â”‚  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   â”‚                                                        â”‚  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   â”‚ .initcall1.init: (core)                               â”‚  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   â”‚   [ mm_init_fn, sched_init_fn, ... ]                  â”‚  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   â”‚                                                        â”‚  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   â”‚ .initcall2.init: (postcore)                           â”‚  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   â”‚   [ pci_init, ... ]                                   â”‚  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   â”‚                                                        â”‚  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   â”‚ .initcall3.init: (arch)                               â”‚  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   â”‚   [ acpi_init, ... ]                                  â”‚  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   â”‚                                                        â”‚  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   â”‚ .initcall4.init: (subsys)                             â”‚  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   â”‚   [ bus_init, driver_init, ... ]                      â”‚  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   â”‚                                                        â”‚  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   â”‚ .initcall5.init: (fs)                                 â”‚  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   â”‚   [ inet_init, ext4_init, ... ]                       â”‚  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   â”‚                                                        â”‚  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   â”‚ .initcall6.init: (device)                             â”‚  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   â”‚   [ e1000_init, rtl8169_init, ... ]                   â”‚  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   â”‚                                                        â”‚  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   â”‚ .initcall7.init: (late)                               â”‚  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   â”‚   [ late_fn1, late_fn2, ... ]                         â”‚  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   â”‚                                                        â”‚  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   â”‚ __initcall_end:                                       â”‚  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚                                                               â”‚  â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚   é«˜åœ°å€                                                                     â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. ä»£ç æµç¨‹åˆ†æ

### 4.1 å®å±•å¼€è¿‡ç¨‹

```c
// åŸå§‹ä»£ç 
static int __init inet_init(void)
{
    // åˆå§‹åŒ–ç½‘ç»œåè®®æ ˆ
}
fs_initcall(inet_init);

// å®å±•å¼€å
static int __init inet_init(void)
{
    // åˆå§‹åŒ–ç½‘ç»œåè®®æ ˆ
}
static initcall_t __initcall_inet_init5    // å˜é‡å
    __used                                  // é˜²æ­¢è¢«ä¼˜åŒ–æ‰
    __attribute__((__section__(".initcall5.init")))  // æ”¾å…¥ç‰¹å®šèŠ‚åŒº
    = inet_init;                            // æŒ‡å‘å‡½æ•°
```

### 4.2 æ¡†æ¶æ‰§è¡Œ initcall

```c
// init/main.c (ç¬¬ 660-710 è¡Œ)

// é“¾æ¥å™¨å®šä¹‰çš„ç¬¦å·
extern initcall_t __initcall_start[], __initcall_end[], __early_initcall_end[];

// æ‰§è¡Œå•ä¸ª initcall
int __init_or_module do_one_initcall(initcall_t fn)
{
    int count = preempt_count();
    int ret;
    char msgbuf[64];

    // è°ƒè¯•è¾“å‡º
    if (initcall_debug)
        printk(KERN_DEBUG "calling  %pF @ %i\n", fn, task_pid_nr(current));

    // è°ƒç”¨æ³¨å…¥çš„åˆå§‹åŒ–å‡½æ•°
    ret = fn();

    // æ£€æŸ¥å‡½æ•°æ˜¯å¦æ­£ç¡®è¿”å›
    msgbuf[0] = 0;

    if (preempt_count() != count) {
        sprintf(msgbuf + strlen(msgbuf),
            "preemption imbalance ");
        preempt_count() = count;
    }
    if (irqs_disabled()) {
        strlcat(msgbuf, "disabled interrupts ", sizeof(msgbuf));
        local_irq_enable();
    }

    if (msgbuf[0]) {
        printk(KERN_WARNING "initcall %pF returned with %s\n", fn, msgbuf);
    }

    return ret;
}

// éå†æ‰§è¡Œæ‰€æœ‰ initcall
static void __init do_initcalls(void)
{
    initcall_t *fn;

    // ä» __early_initcall_end å¼€å§‹ (early å·²åœ¨ SMP å‰æ‰§è¡Œ)
    for (fn = __early_initcall_end; fn < __initcall_end; fn++)
        do_one_initcall(*fn);
}
```

### 4.3 å¯åŠ¨æµç¨‹ä¸­çš„ initcall

```c
// init/main.c

static void __init do_basic_setup(void)
{
    cpuset_init_smp();          // SMP cpuset åˆå§‹åŒ–
    usermodehelper_init();      // ç”¨æˆ·æ¨¡å¼å¸®åŠ©è¿›ç¨‹
    shmem_init();               // å…±äº«å†…å­˜
    driver_init();              // é©±åŠ¨æ¨¡å‹åˆå§‹åŒ–
    init_irq_proc();            // /proc/irq
    do_ctors();                 // C++ æ„é€ å‡½æ•°
    usermodehelper_enable();
    do_initcalls();             // â—„â”€â”€ æ‰§è¡Œæ‰€æœ‰ initcall
}

static void __init do_pre_smp_initcalls(void)
{
    initcall_t *fn;

    // early initcall åœ¨ SMP åˆå§‹åŒ–å‰æ‰§è¡Œ
    for (fn = __initcall_start; fn < __early_initcall_end; fn++)
        do_one_initcall(*fn);
}

// å†…æ ¸å¯åŠ¨ä¸»æµç¨‹
asmlinkage void __init start_kernel(void)
{
    // ... æ—©æœŸåˆå§‹åŒ– ...

    // SMP å‰çš„ early initcall
    do_pre_smp_initcalls();

    smp_init();                 // å¯åŠ¨å…¶ä»– CPU

    // ... å…¶ä»–åˆå§‹åŒ– ...

    // æ‰§è¡Œ do_basic_setup (åŒ…å« do_initcalls)
    kernel_init();
}
```

### 4.4 å®Œæ•´è°ƒç”¨æµç¨‹

```
                    start_kernel()
                          â”‚
                          â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                           â”‚
            â–¼                           â”‚
    do_pre_smp_initcalls()             â”‚
            â”‚                           â”‚
            â”‚  éå† early initcall      â”‚
            â”‚                           â”‚
            â–¼                           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              smp_init()
    â”‚ early_fn1()   â”‚                  â”‚
    â”‚ early_fn2()   â”‚                  â”‚  å¯åŠ¨å…¶ä»– CPU
    â”‚ ...           â”‚                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
                                       â”‚
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
                    kernel_init()
                          â”‚
                          â–¼
                   do_basic_setup()
                          â”‚
                          â–¼
                    do_initcalls()
                          â”‚
                          â”‚  éå†æ‰€æœ‰ initcall
                          â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                     â”‚                     â”‚
    â–¼                     â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ level 0  â”‚        â”‚ level 5  â”‚        â”‚ level 7  â”‚
â”‚ pure     â”‚  ...   â”‚ fs       â”‚  ...   â”‚ late     â”‚
â”‚          â”‚        â”‚          â”‚        â”‚          â”‚
â”‚ pure_fn1 â”‚        â”‚ inet_initâ”‚        â”‚ late_fn1 â”‚
â”‚ pure_fn2 â”‚        â”‚ ext4_initâ”‚        â”‚ late_fn2 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. å®é™…æ¡ˆä¾‹

### æ¡ˆä¾‹1: ç½‘ç»œåè®®æ ˆåˆå§‹åŒ–

```c
// net/ipv4/af_inet.c

static int __init inet_init(void)
{
    struct sk_buff *dummy_skb;
    struct inet_protosw *q;
    struct list_head *r;
    int rc = -EINVAL;

    // æ³¨å†Œåè®®æ—
    (void)sock_register(&inet_family_ops);

    // åˆå§‹åŒ–åè®® hash è¡¨
    for (r = &inetsw[0]; r < &inetsw[SOCK_MAX]; ++r)
        INIT_LIST_HEAD(r);

    // æ³¨å†Œå†…ç½®åè®®
    for (q = inetsw_array; q < &inetsw_array[INETSW_ARRAY_LEN]; ++q)
        inet_register_protosw(q);

    // åˆå§‹åŒ– ARP
    arp_init();

    // åˆå§‹åŒ– IP
    ip_init();

    // åˆå§‹åŒ– TCP
    tcp_init();

    // åˆå§‹åŒ– UDP
    udp_init();

    // åˆå§‹åŒ– ICMP
    icmp_init();

    // åˆå§‹åŒ– IP åˆ†ç‰‡
    ipfrag_init();

    return 0;
}

// ä½¿ç”¨ fs_initcall (çº§åˆ« 5)
// å› ä¸ºç½‘ç»œéœ€è¦åœ¨è®¾å¤‡é©±åŠ¨ (çº§åˆ« 6) ä¹‹å‰åˆå§‹åŒ–
fs_initcall(inet_init);
```

### æ¡ˆä¾‹2: PCI å­ç³»ç»Ÿåˆå§‹åŒ–

```c
// drivers/pci/pci.c

// PCI æ ¸å¿ƒåˆå§‹åŒ– - çº§åˆ« 2 (postcore)
static int __init pci_driver_init(void)
{
    return bus_register(&pci_bus_type);
}
postcore_initcall(pci_driver_init);

// drivers/pci/pci-driver.c

// PCI é©±åŠ¨æ¡†æ¶ - çº§åˆ« 4 (subsys)
static int __init pci_subsys_init(void)
{
    // æ‰«æ PCI æ€»çº¿
    pci_legacy_init();
    pcibios_irq_init();
    pci_assign_unassigned_resources();
    return 0;
}
subsys_initcall(pci_subsys_init);
```

### æ¡ˆä¾‹3: ext4 æ–‡ä»¶ç³»ç»Ÿ

```c
// fs/ext4/super.c

static int __init ext4_init_fs(void)
{
    int err;

    // åˆå§‹åŒ– slab ç¼“å­˜
    err = ext4_init_pageio();
    if (err)
        return err;

    err = ext4_init_system_zone();
    if (err)
        goto out1;

    // åˆå§‹åŒ– mballoc
    err = ext4_init_mballoc();
    if (err)
        goto out2;

    // åˆå§‹åŒ– xattr
    err = init_ext4_xattr();
    if (err)
        goto out3;

    // æ³¨å†Œæ–‡ä»¶ç³»ç»Ÿ
    err = register_filesystem(&ext4_fs_type);
    if (err)
        goto out4;

    return 0;

out4:
    exit_ext4_xattr();
out3:
    ext4_exit_mballoc();
out2:
    ext4_exit_system_zone();
out1:
    ext4_exit_pageio();
    return err;
}

// ä½¿ç”¨ module_init (ç­‰äº device_initcall, çº§åˆ« 6)
// å› ä¸ºæ–‡ä»¶ç³»ç»Ÿæ˜¯å¯åŠ è½½æ¨¡å—
module_init(ext4_init_fs);
module_exit(ext4_exit_fs);
```

### æ¡ˆä¾‹4: æ¨¡å—ä¸é™æ€ç¼–è¯‘çš„ç»Ÿä¸€

```c
// åŒä¸€ä»½ä»£ç ï¼Œæ”¯æŒä¸¤ç§ç¼–è¯‘æ–¹å¼

static int __init my_driver_init(void)
{
    printk(KERN_INFO "my_driver: initializing\n");
    // åˆå§‹åŒ–ä»£ç 
    return 0;
}

static void __exit my_driver_exit(void)
{
    printk(KERN_INFO "my_driver: exiting\n");
    // æ¸…ç†ä»£ç 
}

module_init(my_driver_init);
module_exit(my_driver_exit);

// å½“ CONFIG_MY_DRIVER=y (é™æ€ç¼–è¯‘) æ—¶:
//   module_init å±•å¼€ä¸º device_initcall
//   å‡½æ•°æŒ‡é’ˆæ”¾å…¥ .initcall6.init
//   do_initcalls() ä¼šè°ƒç”¨å®ƒ

// å½“ CONFIG_MY_DRIVER=m (æ¨¡å—) æ—¶:
//   module_init å±•å¼€ä¸º init_module çš„åˆ«å
//   insmod æ—¶ç”±æ¨¡å—åŠ è½½å™¨è°ƒç”¨
```

---

## 6. ä¼˜åŠ¿åˆ†æ

### 6.1 è‡ªåŠ¨åŒ–çš„åˆå§‹åŒ–é¡ºåº

```c
// ä¼ ç»Ÿæ–¹å¼: éœ€è¦æ‰‹åŠ¨è°ƒç”¨
void kernel_init(void)
{
    mm_init();          // å†…å­˜ç®¡ç†
    pci_init();         // PCI
    bus_init();         // æ€»çº¿
    net_init();         // ç½‘ç»œ
    fs_init();          // æ–‡ä»¶ç³»ç»Ÿ
    driver_a_init();    // é©±åŠ¨ A
    driver_b_init();    // é©±åŠ¨ B
    // æ·»åŠ æ–°é©±åŠ¨éœ€è¦ä¿®æ”¹è¿™é‡Œ
}

// initcall æ–¹å¼: å£°æ˜å¼
// å„æ¨¡å—ç‹¬ç«‹å£°æ˜ï¼Œæ— éœ€ä¿®æ”¹ä¸­å¤®ä»£ç 
core_initcall(mm_init);
postcore_initcall(pci_init);
subsys_initcall(bus_init);
fs_initcall(net_init);
fs_initcall(fs_init);
device_initcall(driver_a_init);
device_initcall(driver_b_init);
```

### 6.2 ç¼–è¯‘æ—¶ä¾èµ–æ³¨å…¥

```
ç¼–è¯‘æ—¶:                           è¿è¡Œæ—¶:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å„æ¨¡å—ç‹¬ç«‹ç¼–è¯‘          â”‚      â”‚                         â”‚
â”‚                          â”‚      â”‚  do_initcalls()         â”‚
â”‚  fs/ext4/super.c â”€â”€â”    â”‚      â”‚      â”‚                   â”‚
â”‚                     â”‚    â”‚      â”‚      â”‚ éå†æ•°ç»„         â”‚
â”‚  net/ipv4/af_inet.c â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤                   â”‚
â”‚                     â”‚    â”‚ é“¾æ¥ â”‚      â”‚                   â”‚
â”‚  drivers/pci/pci.c â”€â”˜    â”‚  å™¨  â”‚      â–¼                   â”‚
â”‚                          â”‚      â”‚  è°ƒç”¨å„åˆå§‹åŒ–å‡½æ•°       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 åˆå§‹åŒ–å†…å­˜å›æ”¶

```c
// __init æ ‡è®°çš„å‡½æ•°å’Œ __initdata æ ‡è®°çš„æ•°æ®
// åœ¨åˆå§‹åŒ–å®Œæˆåå¯ä»¥é‡Šæ”¾

// init/main.c
static int init_post(void)
{
    // ... å®Œæˆæ‰€æœ‰åˆå§‹åŒ–å ...

    // é‡Šæ”¾ .init èŠ‚åŒºçš„å†…å­˜
    free_initmem();

    // é‡Šæ”¾çš„å†…å­˜å¯ä»¥è¢«ç³»ç»Ÿå…¶ä»–éƒ¨åˆ†ä½¿ç”¨
    return 0;
}

// arch/x86/mm/init.c
void free_initmem(void)
{
    unsigned long start = (unsigned long)__init_begin;
    unsigned long end = (unsigned long)__init_end;

    // é‡Šæ”¾ [__init_begin, __init_end) èŒƒå›´çš„é¡µé¢
    free_init_pages("unused kernel memory", start, end);
}
```

---

## 7. å¯¹æ¯”æ€è€ƒ

### å¦‚æœä¸ä½¿ç”¨ initcall

```c
// ä¼ ç»Ÿæ–¹å¼: ä¸­å¤®è°ƒåº¦

void do_all_init(void)
{
    // é—®é¢˜1: éœ€è¦çŸ¥é“æ‰€æœ‰æ¨¡å—çš„åˆå§‹åŒ–å‡½æ•°
    mm_init();
    pci_init();
    net_init();
    ext4_init();
    e1000_init();
    // ...

    // é—®é¢˜2: æ·»åŠ æ–°æ¨¡å—éœ€è¦ä¿®æ”¹æ­¤å‡½æ•°
    // é—®é¢˜3: é¡ºåºä¾èµ–éœ€è¦æ‰‹åŠ¨ç»´æŠ¤
    // é—®é¢˜4: æ¡ä»¶ç¼–è¯‘å¾ˆå¤æ‚
    #ifdef CONFIG_EXT4
    ext4_init();
    #endif
    #ifdef CONFIG_E1000
    e1000_init();
    #endif
}
```

### initcall çš„å¥½å¤„

| æ–¹é¢ | ä¼ ç»Ÿæ–¹å¼ | initcall æ–¹å¼ |
|------|----------|---------------|
| æ·»åŠ æ–°æ¨¡å— | ä¿®æ”¹ä¸­å¤®ä»£ç  | åªéœ€æ·»åŠ å£°æ˜ |
| é¡ºåºæ§åˆ¶ | æ‰‹åŠ¨æ’åº | çº§åˆ«è‡ªåŠ¨æ’åº |
| æ¡ä»¶ç¼–è¯‘ | å¤æ‚çš„ #ifdef | è‡ªåŠ¨å¤„ç† |
| æ¨¡å—æ”¯æŒ | éœ€è¦ä¸¤å¥—ä»£ç  | ç»Ÿä¸€ä»£ç  |
| ä»£ç è€¦åˆ | é«˜ | é›¶è€¦åˆ |

---

## 8. ç›¸å…³ API

### initcall å®

```c
// æŒ‰æ‰§è¡Œé¡ºåº
early_initcall(fn)      // SMP åˆå§‹åŒ–å‰
pure_initcall(fn)       // æœ€æ—©ï¼Œæ— ä¾èµ–
core_initcall(fn)       // æ ¸å¿ƒå­ç³»ç»Ÿ
postcore_initcall(fn)   // æ ¸å¿ƒå
arch_initcall(fn)       // æ¶æ„ç›¸å…³
subsys_initcall(fn)     // å­ç³»ç»Ÿ
fs_initcall(fn)         // æ–‡ä»¶ç³»ç»Ÿ
rootfs_initcall(fn)     // æ ¹æ–‡ä»¶ç³»ç»Ÿ
device_initcall(fn)     // è®¾å¤‡é©±åŠ¨ (module_init é»˜è®¤)
late_initcall(fn)       // æœ€å

// åŒæ­¥å˜ä½“ (ç”¨äºç­‰å¾…å‰ä¸€çº§åˆ«å®Œæˆ)
core_initcall_sync(fn)
// ... å…¶ä»–çº§åˆ«çš„ _sync å˜ä½“
```

### ç‰¹æ®Š initcall

```c
// æ§åˆ¶å°åˆå§‹åŒ–
console_initcall(fn)

// å®‰å…¨æ¨¡å—åˆå§‹åŒ–
security_initcall(fn)
```

### æ¨¡å—æ”¯æŒ

```c
// æ¨¡å—åˆå§‹åŒ–/é€€å‡º (é™æ€ç¼–è¯‘æ—¶ç­‰äº initcall)
module_init(fn)
module_exit(fn)

// é©±åŠ¨æ¨¡å‹ä¾¿æ·å®
module_pci_driver(drv)
module_platform_driver(drv)
module_usb_driver(drv)
```

### å†…å­˜æ ‡è®°

```c
// åˆå§‹åŒ–å‡½æ•°æ ‡è®° (å¯åŠ¨åå¯é‡Šæ”¾)
#define __init __section(.init.text) __cold notrace

// åˆå§‹åŒ–æ•°æ®æ ‡è®°
#define __initdata __section(.init.data)

// åªè¯»åˆå§‹åŒ–æ•°æ®
#define __initconst __section(.init.rodata)
```

---

## ğŸ¤” æ€è€ƒé¢˜

1. **ä¸ºä»€ä¹ˆ fs_initcall åœ¨ device_initcall ä¹‹å‰ï¼Ÿ**
   - æç¤º: è€ƒè™‘ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿçš„ä¾èµ–

2. **early_initcall å’Œå…¶ä»– initcall æœ‰ä»€ä¹ˆæœ¬è´¨åŒºåˆ«ï¼Ÿ**
   - æç¤º: æŸ¥çœ‹ SMP åˆå§‹åŒ–æ—¶æœº

3. **å¦‚æœä¸¤ä¸ªæ¨¡å—éƒ½ç”¨ fs_initcallï¼Œå®ƒä»¬çš„åˆå§‹åŒ–é¡ºåºå¦‚ä½•ç¡®å®šï¼Ÿ**
   - æç¤º: æŸ¥çœ‹é“¾æ¥å™¨è¡Œä¸º

4. **module_init å¦‚ä½•åŒæ—¶æ”¯æŒé™æ€ç¼–è¯‘å’Œæ¨¡å—åŠ è½½ï¼Ÿ**
   - æç¤º: æŸ¥çœ‹ MODULE å®å®šä¹‰

---

## ğŸ“š ç›¸å…³æºç æ–‡ä»¶

| æ–‡ä»¶ | è¡Œæ•° | å†…å®¹ |
|------|------|------|
| `include/linux/init.h` | 1-350 | initcall å®å®šä¹‰ |
| `init/main.c` | 1-900 | do_initcalls å®ç° |
| `include/asm-generic/vmlinux.lds.h` | 1-900 | é“¾æ¥å™¨è„šæœ¬æ¨¡æ¿ |
| `arch/x86/kernel/vmlinux.lds.S` | - | x86 é“¾æ¥å™¨è„šæœ¬ |
| `scripts/sortextable.c` | - | æ’åºå·¥å…· |

