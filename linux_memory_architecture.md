# Linux 3.2 内存管理架构深入解析

---

## 目录

- [内存管理架构总览](#内存管理架构总览)
- [物理内存组织](#物理内存组织)
- [核心数据结构详解](#核心数据结构详解)
- [虚拟内存管理](#虚拟内存管理)
- [页表与地址转换](#页表与地址转换)
- [内存分配子系统](#内存分配子系统)
- [页面回收机制](#页面回收机制)
- [关键源码文件](#关键源码文件)

---

## 内存管理架构总览

### 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        Linux 内存管理架构                                        │
└─────────────────────────────────────────────────────────────────────────────────┘

                              用户空间进程
                                   │
                                   │ malloc() / mmap() / brk()
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           虚拟内存层 (Virtual Memory)                            │
│                                                                                  │
│   ┌──────────────────────────────────────────────────────────────────────────┐  │
│   │                      进程地址空间 (mm_struct)                             │  │
│   │                                                                           │  │
│   │   ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │  │
│   │   │  代码段  │ │  数据段  │ │    堆   │ │  mmap   │ │    栈   │           │  │
│   │   │  VMA    │ │  VMA    │  │  VMA   │ │  VMA    │ │  VMA   │           │  │
│   │   └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘           │  │
│   │        │           │           │           │           │                 │  │
│   │        └───────────┴───────────┴───────────┴───────────┘                 │  │
│   │                                │                                          │  │
│   │                                ▼                                          │  │
│   │                     ┌─────────────────────┐                              │  │
│   │                     │     页表 (PGD)       │                              │  │
│   │                     │   PUD → PMD → PTE   │                              │  │
│   │                     └──────────┬──────────┘                              │  │
│   └───────────────────────────────┼──────────────────────────────────────────┘  │
│                                   │                                              │
└───────────────────────────────────┼──────────────────────────────────────────────┘
                                    │ 虚拟地址 → 物理地址
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           物理内存层 (Physical Memory)                           │
│                                                                                  │
│   ┌──────────────────────────────────────────────────────────────────────────┐  │
│   │                        NUMA 节点 (pg_data_t)                              │  │
│   │                                                                           │  │
│   │   ┌─────────────────────────────────────────────────────────────────┐    │  │
│   │   │     Node 0                              Node 1                   │    │  │
│   │   │   ┌───────────────────────┐         ┌───────────────────────┐   │    │  │
│   │   │   │ Zone DMA   (0-16MB)   │         │ Zone DMA   (0-16MB)   │   │    │  │
│   │   │   ├───────────────────────┤         ├───────────────────────┤   │    │  │
│   │   │   │ Zone Normal (16-896MB)│         │ Zone Normal           │   │    │  │
│   │   │   ├───────────────────────┤         ├───────────────────────┤   │    │  │
│   │   │   │ Zone HighMem (>896MB) │         │ Zone HighMem          │   │    │  │
│   │   │   └───────────────────────┘         └───────────────────────┘   │    │  │
│   │   └─────────────────────────────────────────────────────────────────┘    │  │
│   └──────────────────────────────────────────────────────────────────────────┘  │
│                                   │                                              │
│   ┌──────────────────────────────────────────────────────────────────────────┐  │
│   │                    伙伴系统 (Buddy System)                                │  │
│   │                                                                           │  │
│   │   free_area[0] ──► 2^0 页 (4KB)                                          │  │
│   │   free_area[1] ──► 2^1 页 (8KB)                                          │  │
│   │   free_area[2] ──► 2^2 页 (16KB)                                         │  │
│   │   ...                                                                     │  │
│   │   free_area[10] ──► 2^10 页 (4MB)                                        │  │
│   └──────────────────────────────────────────────────────────────────────────┘  │
│                                   │                                              │
│   ┌──────────────────────────────────────────────────────────────────────────┐  │
│   │                    Slab/Slub 分配器                                       │  │
│   │                                                                           │  │
│   │   kmem_cache ("task_struct") ──► slabs ──► 固定大小对象                   │  │
│   │   kmem_cache ("inode_cache") ──► slabs ──► 固定大小对象                   │  │
│   │   kmalloc-128, kmalloc-256, ...                                          │  │
│   └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 层次关系

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          内存管理层次结构                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  应用层:    malloc() / free() / mmap() / munmap()                               │
│                              │                                                   │
│                              ▼                                                   │
│  系统调用:  sys_brk() / sys_mmap() / sys_munmap()                               │
│                              │                                                   │
│                              ▼                                                   │
│  VMA层:     vm_area_struct 管理 (find_vma, insert_vma, remove_vma)              │
│                              │                                                   │
│                              ▼                                                   │
│  页表层:    pgd_t → pud_t → pmd_t → pte_t → 物理页                             │
│                              │                                                   │
│                              ▼                                                   │
│  分配层:    ┌─────────────────────────────────────────┐                         │
│             │  Slab/Slub (小对象)  │  Buddy (页分配)   │                         │
│             └──────────┬──────────┴────────┬──────────┘                         │
│                        │                   │                                     │
│                        ▼                   ▼                                     │
│  Zone层:    Zone DMA ─── Zone Normal ─── Zone HighMem                           │
│                              │                                                   │
│                              ▼                                                   │
│  Node层:    pg_data_t (NUMA node 0, 1, 2, ...)                                  │
│                              │                                                   │
│                              ▼                                                   │
│  物理内存:  struct page 数组 (mem_map)                                           │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 物理内存组织

### NUMA 架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          NUMA 内存架构                                           │
│                                                                                  │
│    ┌──────────────────────────────┐      ┌──────────────────────────────┐       │
│    │           Node 0             │      │           Node 1             │       │
│    │                              │      │                              │       │
│    │  ┌────────┐    ┌────────┐   │      │  ┌────────┐    ┌────────┐   │       │
│    │  │ CPU 0  │    │ CPU 1  │   │      │  │ CPU 2  │    │ CPU 3  │   │       │
│    │  └───┬────┘    └───┬────┘   │      │  └───┬────┘    └───┬────┘   │       │
│    │      │             │        │      │      │             │        │       │
│    │      └──────┬──────┘        │      │      └──────┬──────┘        │       │
│    │             │               │      │             │               │       │
│    │             ▼               │      │             ▼               │       │
│    │      ┌────────────┐         │      │      ┌────────────┐         │       │
│    │      │ 本地内存   │         │◄────►│      │ 本地内存   │         │       │
│    │      │  (快速)    │         │ 互联 │      │  (快速)    │         │       │
│    │      └────────────┘         │      │      └────────────┘         │       │
│    │                              │      │                              │       │
│    │   pg_data_t node_data[0]    │      │   pg_data_t node_data[1]    │       │
│    │                              │      │                              │       │
│    └──────────────────────────────┘      └──────────────────────────────┘       │
│                                                                                  │
│   本地访问延迟 < 远程访问延迟                                                     │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### Zone 划分

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    x86-32 物理内存 Zone 划分                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   物理地址                                                                        │
│       │                                                                          │
│   4GB ┼───────────────────────────────────────────────────────────────┐         │
│       │                                                               │         │
│       │                    ZONE_HIGHMEM                               │         │
│       │                                                               │         │
│       │              (高端内存，需要动态映射)                           │         │
│       │                                                               │         │
│  896MB┼───────────────────────────────────────────────────────────────┤         │
│       │                                                               │         │
│       │                    ZONE_NORMAL                                │         │
│       │                                                               │         │
│       │          (直接映射到内核地址空间 PAGE_OFFSET)                   │         │
│       │                                                               │         │
│   16MB┼───────────────────────────────────────────────────────────────┤         │
│       │                                                               │         │
│       │                    ZONE_DMA                                   │         │
│       │                                                               │         │
│       │           (ISA DMA 需要的低端内存)                             │         │
│       │                                                               │         │
│    0MB┼───────────────────────────────────────────────────────────────┘         │
│                                                                                  │
│   ────────────────────────────────────────────────────────────────────────────  │
│                                                                                  │
│   Zone 类型定义 (include/linux/mmzone.h):                                        │
│                                                                                  │
│   enum zone_type {                                                               │
│       ZONE_DMA,           // 0-16MB, ISA DMA                                    │
│       ZONE_DMA32,         // 0-4GB, 32位 DMA 设备 (仅64位系统)                   │
│       ZONE_NORMAL,        // 直接映射区域                                        │
│       ZONE_HIGHMEM,       // 高端内存 (仅32位系统)                               │
│       ZONE_MOVABLE,       // 可移动页面，用于内存热插拔                           │
│       __MAX_NR_ZONES                                                            │
│   };                                                                             │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 核心数据结构详解

### 1. struct page - 物理页描述符

```c
// include/linux/mm_types.h

/*
 * 系统中每个物理页都有一个对应的 struct page
 * 这是内存管理的最基本单位
 */
struct page {
    /* === 第一个双字块 === */
    unsigned long flags;            // 页面状态标志 (PG_locked, PG_dirty, etc.)
    
    struct address_space *mapping;  // 如果低位为0: 指向 inode 的 address_space
                                    // 如果低位为1: 指向 anon_vma (匿名页)
    
    /* === 第二个双字块 === */
    union {
        pgoff_t index;              // 在文件/交换区中的偏移
        void *freelist;             // SLUB: 空闲对象链表头
    };
    
    union {
        atomic_t _mapcount;         // 页表映射计数
        struct {                    // SLUB 使用
            unsigned inuse:16;      // 已使用对象数
            unsigned objects:15;    // 总对象数
            unsigned frozen:1;      // 是否冻结
        };
    };
    
    atomic_t _count;                // 引用计数
    
    /* === 第三个双字块 === */
    union {
        struct list_head lru;       // LRU 链表节点 (active/inactive)
        struct {                    // SLUB per-CPU 部分页
            struct page *next;
            int pages;
            int pobjects;
        };
    };
    
    /* === 其他字段 === */
    union {
        unsigned long private;      // 缓冲区头 / swap 条目 / buddy order
        spinlock_t ptl;             // 页表锁
        struct kmem_cache *slab;    // SLUB: 所属缓存
        struct page *first_page;    // 复合页: 首页指针
    };
};
```

**页面标志位 (flags):**

```c
// include/linux/page-flags.h

enum pageflags {
    PG_locked,          // 页面被锁定 (I/O 进行中)
    PG_error,           // I/O 错误
    PG_referenced,      // 最近被访问
    PG_uptodate,        // 数据有效
    PG_dirty,           // 页面被修改，需写回
    PG_lru,             // 在 LRU 链表中
    PG_active,          // 在活跃 LRU 链表中
    PG_slab,            // SLAB 分配器使用
    PG_reserved,        // 保留页，不可换出
    PG_private,         // 有私有数据
    PG_writeback,       // 正在写回
    PG_compound,        // 复合页
    PG_swapcache,       // 在交换缓存中
    PG_mappedtodisk,    // 有磁盘块映射
    PG_reclaim,         // 准备回收
    PG_swapbacked,      // 由 swap 支持的匿名页
    PG_unevictable,     // 不可驱逐
    PG_mlocked,         // mlock() 锁定
    // ...
};
```

### 2. struct zone - 内存区域

```c
// include/linux/mmzone.h

struct zone {
    /* === 页分配器常用字段 === */
    
    unsigned long watermark[NR_WMARK];  // 水位线 (min, low, high)
    
    unsigned long lowmem_reserve[MAX_NR_ZONES]; // 保留内存
    
    struct per_cpu_pageset __percpu *pageset;   // Per-CPU 页面缓存
    
    spinlock_t lock;                    // zone 锁
    
    struct free_area free_area[MAX_ORDER];      // ★ 伙伴系统空闲链表
    
    /* === 页面回收相关 === */
    
    spinlock_t lru_lock;                // LRU 链表锁
    
    struct zone_lru {
        struct list_head list;          // LRU 链表
    } lru[NR_LRU_LISTS];                // 5 个 LRU 链表
    
    struct zone_reclaim_stat reclaim_stat;  // 回收统计
    
    unsigned long pages_scanned;        // 扫描的页数
    unsigned long flags;                // zone 标志
    
    /* === 统计信息 === */
    
    atomic_long_t vm_stat[NR_VM_ZONE_STAT_ITEMS];
    
    /* === 拓扑信息 === */
    
    struct pglist_data *zone_pgdat;     // 所属 NUMA 节点
    unsigned long zone_start_pfn;       // 起始页帧号
    unsigned long spanned_pages;        // 总页数 (含空洞)
    unsigned long present_pages;        // 实际页数 (不含空洞)
    
    const char *name;                   // zone 名称
};
```

**水位线机制:**

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          Zone 水位线机制                                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   空闲页数                                                                        │
│       ▲                                                                          │
│       │                                                                          │
│  high ┼────────────────────────────────────────  高水位                          │
│       │                ↑                                                         │
│       │                │ 唤醒 kswapd 后台回收                                    │
│       │                │                                                         │
│   low ┼────────────────┼───────────────────────  低水位                          │
│       │                │                                                         │
│       │                │ kswapd 回收到高水位后停止                               │
│       │                ↓                                                         │
│   min ┼────────────────────────────────────────  最低水位                        │
│       │                                                                          │
│       │                ← 直接回收 (同步，阻塞分配者)                             │
│       │                                                                          │
│     0 ┼────────────────────────────────────────                                  │
│                                                                                  │
│   分配策略:                                                                       │
│   - 空闲 >= high: 正常分配                                                        │
│   - low <= 空闲 < high: 分配成功，但唤醒 kswapd                                  │
│   - min <= 空闲 < low: 触发直接回收                                               │
│   - 空闲 < min: 分配可能失败 (除非 __GFP_HIGH)                                   │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 3. struct free_area - 伙伴系统

```c
// include/linux/mmzone.h

#define MAX_ORDER 11    // 最大阶数，2^10 = 1024 页 = 4MB

struct free_area {
    struct list_head free_list[MIGRATE_TYPES];  // 不同迁移类型的空闲链表
    unsigned long nr_free;                       // 空闲块数量
};

// 迁移类型
#define MIGRATE_UNMOVABLE     0  // 不可移动 (内核数据)
#define MIGRATE_RECLAIMABLE   1  // 可回收 (页缓存)
#define MIGRATE_MOVABLE       2  // 可移动 (用户数据)
#define MIGRATE_RESERVE       3  // 保留
#define MIGRATE_ISOLATE       4  // 隔离
```

**伙伴系统结构:**

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          伙伴系统 (Buddy System)                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   zone->free_area[]                                                              │
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │ order=0  (4KB)   free_list[UNMOVABLE] ──► page ──► page ──► page       │   │
│   │                  free_list[MOVABLE]   ──► page ──► page                │   │
│   │                  nr_free = 5                                            │   │
│   ├─────────────────────────────────────────────────────────────────────────┤   │
│   │ order=1  (8KB)   free_list[UNMOVABLE] ──► page                         │   │
│   │                  free_list[MOVABLE]   ──► page ──► page                │   │
│   │                  nr_free = 3                                            │   │
│   ├─────────────────────────────────────────────────────────────────────────┤   │
│   │ order=2  (16KB)  free_list[MOVABLE]   ──► page                         │   │
│   │                  nr_free = 1                                            │   │
│   ├─────────────────────────────────────────────────────────────────────────┤   │
│   │ ...                                                                     │   │
│   ├─────────────────────────────────────────────────────────────────────────┤   │
│   │ order=10 (4MB)   free_list[MOVABLE]   ──► page                         │   │
│   │                  nr_free = 1                                            │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│   分配 order=2 的块:                                                             │
│   1. 首先查找 free_area[2]                                                       │
│   2. 如果为空，查找 free_area[3] 并分裂                                          │
│   3. 继续向上查找直到找到可用块                                                  │
│                                                                                  │
│   释放时:                                                                         │
│   1. 查找伙伴块 (地址相邻且同 order)                                             │
│   2. 如果伙伴空闲，合并为更大块                                                  │
│   3. 递归合并直到无法继续                                                        │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 4. struct pg_data_t - NUMA 节点

```c
// include/linux/mmzone.h

typedef struct pglist_data {
    struct zone node_zones[MAX_NR_ZONES];   // 该节点的 zone 数组
    
    struct zonelist node_zonelists[MAX_ZONELISTS]; // zone 分配顺序列表
    
    int nr_zones;                           // zone 数量
    
    struct page *node_mem_map;              // 页描述符数组 (mem_map)
    
    struct bootmem_data *bdata;             // 引导期内存分配
    
    unsigned long node_start_pfn;           // 起始页帧号
    unsigned long node_present_pages;       // 实际页数
    unsigned long node_spanned_pages;       // 总页数 (含空洞)
    
    int node_id;                            // 节点 ID
    
    wait_queue_head_t kswapd_wait;          // kswapd 等待队列
    struct task_struct *kswapd;             // kswapd 内核线程
    
    // ...
} pg_data_t;
```

### 5. struct vm_area_struct - 虚拟内存区域

```c
// include/linux/mm_types.h

struct vm_area_struct {
    struct mm_struct *vm_mm;        // 所属进程地址空间
    
    unsigned long vm_start;         // 起始虚拟地址
    unsigned long vm_end;           // 结束虚拟地址
    
    struct vm_area_struct *vm_next, *vm_prev;  // VMA 链表
    
    pgprot_t vm_page_prot;          // 页保护属性
    unsigned long vm_flags;         // VMA 标志
    
    struct rb_node vm_rb;           // 红黑树节点 (快速查找)
    
    struct anon_vma *anon_vma;      // 匿名 VMA 链表 (反向映射)
    
    const struct vm_operations_struct *vm_ops; // VMA 操作函数
    
    unsigned long vm_pgoff;         // 文件偏移 (页为单位)
    struct file *vm_file;           // 映射的文件
    void *vm_private_data;          // 私有数据
};
```

**VMA 标志:**

```c
// include/linux/mm.h

#define VM_READ         0x00000001  // 可读
#define VM_WRITE        0x00000002  // 可写
#define VM_EXEC         0x00000004  // 可执行
#define VM_SHARED       0x00000008  // 共享映射

#define VM_MAYREAD      0x00000010  // 可设为可读
#define VM_MAYWRITE     0x00000020  // 可设为可写
#define VM_MAYEXEC      0x00000040  // 可设为可执行
#define VM_MAYSHARE     0x00000080  // 可设为共享

#define VM_GROWSDOWN    0x00000100  // 向下增长 (栈)
#define VM_GROWSUP      0x00000200  // 向上增长
#define VM_PFNMAP       0x00000400  // 页帧号映射
#define VM_DENYWRITE    0x00000800  // 禁止写

#define VM_LOCKED       0x00002000  // 锁定 (mlock)
#define VM_IO           0x00004000  // I/O 内存映射
#define VM_DONTCOPY     0x00020000  // fork 时不复制
#define VM_DONTEXPAND   0x00040000  // 不可扩展
#define VM_HUGETLB      0x00400000  // 大页
```

### 6. struct mm_struct - 进程地址空间

```c
// include/linux/mm_types.h

struct mm_struct {
    struct vm_area_struct *mmap;    // VMA 链表头
    struct rb_root mm_rb;           // VMA 红黑树根
    struct vm_area_struct *mmap_cache; // 最近访问的 VMA (缓存)
    
    pgd_t *pgd;                     // 页全局目录
    
    atomic_t mm_users;              // 用户计数 (线程数)
    atomic_t mm_count;              // 引用计数
    
    int map_count;                  // VMA 数量
    
    spinlock_t page_table_lock;     // 页表锁
    struct rw_semaphore mmap_sem;   // mmap 信号量
    
    /* 内存统计 */
    unsigned long total_vm;         // 总页数
    unsigned long locked_vm;        // 锁定页数
    unsigned long shared_vm;        // 共享页数
    unsigned long exec_vm;          // 可执行页数
    unsigned long stack_vm;         // 栈页数
    
    /* 地址空间边界 */
    unsigned long start_code, end_code;     // 代码段
    unsigned long start_data, end_data;     // 数据段
    unsigned long start_brk, brk;           // 堆
    unsigned long start_stack;              // 栈起始
    unsigned long arg_start, arg_end;       // 参数
    unsigned long env_start, env_end;       // 环境变量
    
    mm_context_t context;           // 架构相关 MM 上下文
    
    // ...
};
```

---

## 虚拟内存管理

### 进程地址空间布局 (32位)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                       32位进程虚拟地址空间布局                                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  高地址                                                                          │
│  0xFFFFFFFF ┌────────────────────────────────────────────────────────────────┐  │
│             │                                                                │  │
│             │                     内核空间                                   │  │
│             │                                                                │  │
│             │              (所有进程共享，用户不可访问)                       │  │
│             │                                                                │  │
│  0xC0000000 ├────────────────────────────────────────────────────────────────┤  │
│  (PAGE_OFFSET)                                                               │  │
│             │                        栈                                      │  │
│             │                    (向下增长)                                  │  │
│             │                        ↓                                       │  │
│             │                                                                │  │
│             │                       ...                                      │  │
│             │                                                                │  │
│             │                        ↑                                       │  │
│             │                   mmap 区域                                    │  │
│             │              (动态库、文件映射)                                │  │
│             │                        ↑                                       │  │
│             │                                                                │  │
│             │                       ...                                      │  │
│             │                                                                │  │
│             │                        ↑                                       │  │
│             │                        堆                                      │  │
│             │                    (向上增长)                                  │  │
│             ├────────────────────────────────────────────────────────────────┤  │
│             │                      BSS 段                                    │  │
│             │                  (未初始化数据)                                │  │
│             ├────────────────────────────────────────────────────────────────┤  │
│             │                     数据段                                     │  │
│             │                  (已初始化数据)                                │  │
│             ├────────────────────────────────────────────────────────────────┤  │
│             │                     代码段                                     │  │
│             │                    (只读)                                      │  │
│  0x08048000 ├────────────────────────────────────────────────────────────────┤  │
│             │                                                                │  │
│             │                    保留区域                                    │  │
│             │                  (NULL 指针捕获)                               │  │
│  0x00000000 └────────────────────────────────────────────────────────────────┘  │
│  低地址                                                                          │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### VMA 组织结构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           VMA 数据结构组织                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   mm_struct                                                                      │
│   ┌───────────────────────────────────────────────────────────────────────┐     │
│   │  mmap ─────────────────┐                                              │     │
│   │  mm_rb (红黑树根) ─────┼──────────────────────────────────┐           │     │
│   │  mmap_cache ───────┐   │                                  │           │     │
│   │  pgd ────────────┐ │   │                                  │           │     │
│   └──────────────────┼─┼───┼──────────────────────────────────┼───────────┘     │
│                      │ │   │                                  │                  │
│                      │ │   │   链表 (按地址排序)               │   红黑树         │
│                      │ │   ▼                                  ▼                  │
│                      │ │   ┌─────────┐    ┌─────────┐    ┌─────────┐            │
│                      │ │   │  VMA1   │───►│  VMA2   │───►│  VMA3   │            │
│                      │ │   │ 代码段  │    │ 数据段  │    │   堆    │            │
│                      │ │   │0x400000-│    │0x600000-│    │0x800000-│            │
│                      │ │   │0x450000 │    │0x620000 │    │0x900000 │            │
│                      │ │   └─────────┘    └─────────┘    └─────────┘            │
│                      │ │        │              │              │                  │
│                      │ │        │              │              │                  │
│                      │ │        └──────────────┼──────────────┘                  │
│                      │ │                       │                                 │
│                      │ │                       ▼                                 │
│                      │ │               ┌───────────────┐                        │
│                      │ └──────────────►│    红黑树     │ O(log n) 查找          │
│                      │                 │               │                        │
│                      │                 │   VMA2 (根)   │                        │
│                      │                 │   /      \    │                        │
│                      │                 │ VMA1    VMA3  │                        │
│                      │                 └───────────────┘                        │
│                      │                                                          │
│                      ▼                                                          │
│               ┌────────────┐                                                    │
│               │    页表    │                                                    │
│               │   (PGD)    │                                                    │
│               └────────────┘                                                    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 页表与地址转换

### 4级页表结构 (x86-64)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        x86-64 四级页表结构                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   虚拟地址 (48位有效)                                                             │
│   ┌──────────────────────────────────────────────────────────────────────────┐  │
│   │ 63    48 │ 47    39 │ 38    30 │ 29    21 │ 20    12 │ 11     0 │        │  │
│   │ (符号扩展)│   PGD    │   PUD    │   PMD    │   PTE    │  Offset  │        │  │
│   │  16位     │   9位    │   9位    │   9位    │   9位    │   12位   │        │  │
│   └──────────┴──────────┴──────────┴──────────┴──────────┴──────────┘        │  │
│                    │          │          │          │          │              │  │
│                    │          │          │          │          │              │  │
│      CR3 ──────────┘          │          │          │          │              │  │
│        │                      │          │          │          │              │  │
│        ▼                      │          │          │          │              │  │
│   ┌─────────────┐             │          │          │          │              │  │
│   │     PGD     │ 页全局目录   │          │          │          │              │  │
│   │ (512 项)    │─────────────┘          │          │          │              │  │
│   │   pgd_t     │                        │          │          │              │  │
│   └──────┬──────┘                        │          │          │              │  │
│          │                               │          │          │              │  │
│          ▼                               │          │          │              │  │
│   ┌─────────────┐                        │          │          │              │  │
│   │     PUD     │ 页上层目录              │          │          │              │  │
│   │ (512 项)    │────────────────────────┘          │          │              │  │
│   │   pud_t     │                                   │          │              │  │
│   └──────┬──────┘                                   │          │              │  │
│          │                                          │          │              │  │
│          ▼                                          │          │              │  │
│   ┌─────────────┐                                   │          │              │  │
│   │     PMD     │ 页中间目录                         │          │              │  │
│   │ (512 项)    │───────────────────────────────────┘          │              │  │
│   │   pmd_t     │                                              │              │  │
│   └──────┬──────┘                                              │              │  │
│          │                                                     │              │  │
│          ▼                                                     │              │  │
│   ┌─────────────┐                                              │              │  │
│   │     PTE     │ 页表项                                        │              │  │
│   │ (512 项)    │──────────────────────────────────────────────┘              │  │
│   │   pte_t     │                                                             │  │
│   └──────┬──────┘                                                             │  │
│          │                                                                    │  │
│          ▼                                                                    │  │
│   ┌─────────────┐                                                             │  │
│   │  物理页帧   │ + 页内偏移 = 物理地址                                         │  │
│   │   (4KB)     │                                                             │  │
│   └─────────────┘                                                             │  │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 页表项格式 (PTE)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          x86-64 页表项格式                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   63  62       52 51                             12 11  9 8 7 6 5 4 3 2 1 0     │
│   ┌───┬──────────┬────────────────────────────────┬─────┬─┬─┬─┬─┬─┬─┬─┬─┬─┐    │
│   │NX │ 保留/PAT │           物理页帧号            │ AVL │G│0│D│A│C│W│U│W│P│    │
│   │   │          │         (40位, 4KB对齐)        │     │ │ │ │ │D│T│S│ │ │    │
│   └───┴──────────┴────────────────────────────────┴─────┴─┴─┴─┴─┴─┴─┴─┴─┴─┘    │
│                                                                                  │
│   位域说明:                                                                       │
│   ─────────────────────────────────────────────────────────────────────────────  │
│   P   (bit 0)  : Present, 页面存在于物理内存                                     │
│   W   (bit 1)  : Read/Write, 可写                                               │
│   US  (bit 2)  : User/Supervisor, 用户可访问                                     │
│   WT  (bit 3)  : Write-Through, 写透缓存                                         │
│   CD  (bit 4)  : Cache Disabled, 禁用缓存                                        │
│   A   (bit 5)  : Accessed, 已访问 (硬件设置)                                     │
│   D   (bit 6)  : Dirty, 已写入 (硬件设置)                                        │
│   G   (bit 8)  : Global, 全局页 (TLB 不刷新)                                     │
│   NX  (bit 63) : No Execute, 不可执行                                            │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 缺页异常处理

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          缺页异常处理流程                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   访问虚拟地址                                                                    │
│         │                                                                        │
│         ▼                                                                        │
│   MMU 查找页表                                                                   │
│         │                                                                        │
│         ├── PTE 存在且有效 ──► 正常访问                                          │
│         │                                                                        │
│         └── 缺页异常 (Page Fault)                                                │
│                   │                                                              │
│                   ▼                                                              │
│           do_page_fault()                                                        │
│                   │                                                              │
│                   ▼                                                              │
│           find_vma() ── 查找 VMA                                                 │
│                   │                                                              │
│         ┌─────────┼─────────┐                                                    │
│         │         │         │                                                    │
│         ▼         ▼         ▼                                                    │
│     无 VMA    VMA 存在   栈增长                                                   │
│         │     权限错误      │                                                    │
│         ▼         │         ▼                                                    │
│     SIGSEGV       ▼    expand_stack()                                           │
│               SIGSEGV       │                                                    │
│                             ▼                                                    │
│                      handle_mm_fault()                                           │
│                             │                                                    │
│               ┌─────────────┼─────────────┐                                      │
│               │             │             │                                      │
│               ▼             ▼             ▼                                      │
│          匿名页         文件页         COW                                       │
│               │             │             │                                      │
│               ▼             ▼             ▼                                      │
│      do_anonymous_page  do_read_fault  do_wp_page                                │
│               │             │             │                                      │
│               └─────────────┼─────────────┘                                      │
│                             │                                                    │
│                             ▼                                                    │
│                       分配物理页                                                  │
│                       建立页表映射                                                │
│                             │                                                    │
│                             ▼                                                    │
│                       返回继续执行                                                │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 内存分配子系统

### 分配器层次

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          内存分配器层次                                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   应用层                                                                         │
│   ─────────────────────────────────────────────────────────────────────────────  │
│   malloc() / free() / calloc() / realloc()                                      │
│                              │                                                   │
│                              ▼                                                   │
│   glibc 层                                                                       │
│   ─────────────────────────────────────────────────────────────────────────────  │
│   ptmalloc2 ──► brk() / mmap()                                                  │
│                              │                                                   │
│                              ▼                                                   │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                        内核分配器                                        │   │
│   │                                                                          │   │
│   │   ┌─────────────────────────────────────────────────────────────────┐   │   │
│   │   │                   Slab/Slub/Slob 层                              │   │   │
│   │   │                                                                  │   │   │
│   │   │   kmalloc() / kfree()      ──► 通用对象分配                      │   │   │
│   │   │   kmem_cache_alloc/free()  ──► 专用缓存分配                      │   │   │
│   │   │                                                                  │   │   │
│   │   │   ┌────────────┐  ┌────────────┐  ┌────────────┐                │   │   │
│   │   │   │kmalloc-32  │  │kmalloc-64  │  │kmalloc-128 │  ...           │   │   │
│   │   │   └────────────┘  └────────────┘  └────────────┘                │   │   │
│   │   │                                                                  │   │   │
│   │   └──────────────────────────────────────────────────────────────────┘   │   │
│   │                              │                                            │   │
│   │                              ▼                                            │   │
│   │   ┌─────────────────────────────────────────────────────────────────┐   │   │
│   │   │                   伙伴系统 (Buddy System)                        │   │   │
│   │   │                                                                  │   │   │
│   │   │   alloc_pages() / __free_pages()                                │   │   │
│   │   │                                                                  │   │   │
│   │   │   ┌────────────────────────────────────────────────────┐        │   │   │
│   │   │   │ order=0 (4KB) │ order=1 (8KB) │ ... │ order=10 (4MB) │        │   │   │
│   │   │   └────────────────────────────────────────────────────┘        │   │   │
│   │   │                                                                  │   │   │
│   │   └──────────────────────────────────────────────────────────────────┘   │   │
│   │                              │                                            │   │
│   │                              ▼                                            │   │
│   │   ┌─────────────────────────────────────────────────────────────────┐   │   │
│   │   │                    Zone / Node                                   │   │   │
│   │   │                                                                  │   │   │
│   │   │   ZONE_DMA ──► ZONE_NORMAL ──► ZONE_HIGHMEM                     │   │   │
│   │   │                                                                  │   │   │
│   │   └──────────────────────────────────────────────────────────────────┘   │   │
│   │                                                                          │   │
│   └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### Slab/Slub 分配器

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          Slub 分配器结构                                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   kmem_cache 结构                                                                │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  name: "task_struct"                                                     │   │
│   │  size: 2048                                                              │   │
│   │  object_size: 1952                                                       │   │
│   │  offset: (free 指针偏移)                                                 │   │
│   │  oo: (objects per slab, slab order)                                     │   │
│   │                                                                          │   │
│   │  cpu_slab (per-CPU)  ────────────────────────────────────────┐          │   │
│   │  ┌──────────────────────────────────────────────────────┐    │          │   │
│   │  │ CPU 0                                                 │    │          │   │
│   │  │ ┌─────────────────────────────────────────────────┐  │    │          │   │
│   │  │ │ freelist ──► obj ──► obj ──► obj ──► NULL       │  │    │          │   │
│   │  │ │ page     ──► 当前活动 slab                       │  │    │          │   │
│   │  │ │ partial  ──► 部分使用的 slabs 链表               │  │    │          │   │
│   │  │ └─────────────────────────────────────────────────┘  │    │          │   │
│   │  └──────────────────────────────────────────────────────┘    │          │   │
│   │                                                              │          │   │
│   │  node[0] (NUMA node)  ───────────────────────────────────────┘          │   │
│   │  ┌──────────────────────────────────────────────────────┐               │   │
│   │  │ partial ──► slab ──► slab ──► slab (部分使用)        │               │   │
│   │  │ nr_partial: 5                                        │               │   │
│   │  └──────────────────────────────────────────────────────┘               │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│   Slab 页面内部结构:                                                             │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                           一个 Slab                                      │   │
│   │  ┌────────┬────────┬────────┬────────┬────────┬────────┐               │   │
│   │  │ obj 0  │ obj 1  │ obj 2  │ obj 3  │ obj 4  │ obj 5  │               │   │
│   │  │ (使用) │ (空闲) │ (使用) │ (空闲) │ (空闲) │ (使用) │               │   │
│   │  └────────┴───┬────┴────────┴───┬────┴───┬────┴────────┘               │   │
│   │               │                 │        │                              │   │
│   │               └─────────────────┴────────┘                              │   │
│   │               freelist: obj1 → obj3 → obj4 → NULL                       │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 伙伴系统分配示例

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          伙伴系统分配/释放示例                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   请求分配 8KB (order=1):                                                        │
│                                                                                  │
│   1. 查找 free_area[1]                                                          │
│      └── 如果有空闲块，直接分配                                                  │
│      └── 如果为空，继续步骤 2                                                    │
│                                                                                  │
│   2. 查找 free_area[2] (16KB)                                                   │
│      └── 找到一个 16KB 块                                                        │
│      └── 分裂成两个 8KB 块                                                       │
│      └── 返回一个，另一个放入 free_area[1]                                       │
│                                                                                  │
│   ┌────────────────────────┐        ┌────────────┬────────────┐                │
│   │      16KB 块           │   →    │  8KB (返回) │  8KB (空闲) │                │
│   │      order=2           │        │   order=1  │   order=1  │                │
│   └────────────────────────┘        └────────────┴────────────┘                │
│                                                                                  │
│   释放时 - 伙伴合并:                                                             │
│                                                                                  │
│   释放地址 0x1000, order=0                                                       │
│                                                                                  │
│   1. 计算伙伴地址: 0x1000 XOR (PAGE_SIZE << 0) = 0x2000                         │
│                                                                                  │
│   2. 检查伙伴是否空闲且同 order                                                  │
│      └── 是: 从链表移除伙伴，合并为 order+1 块                                   │
│      └── 否: 将当前块加入 free_area[0]                                          │
│                                                                                  │
│   3. 递归合并直到无法继续                                                        │
│                                                                                  │
│   ┌──────────┐ ┌──────────┐      ┌────────────────────────┐                    │
│   │ 0x1000   │ │ 0x2000   │  →   │      合并后的块        │                    │
│   │ order=0  │ │ order=0  │      │      order=1           │                    │
│   │ (释放)    │ │ (伙伴)   │      │      0x1000            │                    │
│   └──────────┘ └──────────┘      └────────────────────────┘                    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 内存分配 API

```c
// ==================== 页分配器 API ====================

// 分配 2^order 个连续页
struct page *alloc_pages(gfp_t gfp_mask, unsigned int order);

// 分配单页
#define alloc_page(gfp_mask) alloc_pages(gfp_mask, 0)

// 获取页的虚拟地址
unsigned long __get_free_pages(gfp_t gfp_mask, unsigned int order);

// 分配并清零
unsigned long get_zeroed_page(gfp_t gfp_mask);

// 释放页
void __free_pages(struct page *page, unsigned int order);
void free_pages(unsigned long addr, unsigned int order);

// ==================== Slab/Slub API ====================

// 创建专用缓存
struct kmem_cache *kmem_cache_create(
    const char *name,       // 缓存名称
    size_t size,            // 对象大小
    size_t align,           // 对齐
    unsigned long flags,    // 标志
    void (*ctor)(void *)    // 构造函数
);

// 销毁缓存
void kmem_cache_destroy(struct kmem_cache *cache);

// 从缓存分配对象
void *kmem_cache_alloc(struct kmem_cache *cache, gfp_t flags);

// 释放对象到缓存
void kmem_cache_free(struct kmem_cache *cache, void *obj);

// ==================== 通用分配 API ====================

// 分配内存 (从通用 kmalloc 缓存)
void *kmalloc(size_t size, gfp_t flags);

// 分配并清零
void *kzalloc(size_t size, gfp_t flags);

// 释放
void kfree(const void *objp);

// 分配虚拟地址连续的内存 (物理可能不连续)
void *vmalloc(unsigned long size);
void vfree(const void *addr);
```

### GFP 标志

```c
// include/linux/gfp.h

// Zone 修饰符
#define __GFP_DMA           0x01u   // 从 ZONE_DMA 分配
#define __GFP_HIGHMEM       0x02u   // 允许 ZONE_HIGHMEM
#define __GFP_DMA32         0x04u   // 从 ZONE_DMA32 分配

// 行为修饰符
#define __GFP_WAIT          0x10u   // 可以睡眠
#define __GFP_HIGH          0x20u   // 高优先级
#define __GFP_IO            0x40u   // 可以启动 I/O
#define __GFP_FS            0x80u   // 可以调用文件系统
#define __GFP_COLD          0x100u  // 使用冷页
#define __GFP_NOWARN        0x200u  // 失败时不警告
#define __GFP_REPEAT        0x400u  // 重试分配
#define __GFP_NOFAIL        0x800u  // 无限重试
#define __GFP_NORETRY       0x1000u // 不重试
#define __GFP_ZERO          0x8000u // 清零

// 常用组合
#define GFP_ATOMIC      (__GFP_HIGH)                    // 原子上下文，不睡眠
#define GFP_KERNEL      (__GFP_WAIT | __GFP_IO | __GFP_FS)  // 内核常规
#define GFP_USER        (__GFP_WAIT | __GFP_IO | __GFP_FS | __GFP_HARDWALL)
#define GFP_HIGHUSER    (__GFP_WAIT | __GFP_IO | __GFP_FS | __GFP_HIGHMEM)
#define GFP_DMA         (__GFP_DMA)
```

---

## 页面回收机制

### LRU 链表结构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           LRU 链表结构                                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   zone->lru[NR_LRU_LISTS]                                                        │
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │ LRU_INACTIVE_ANON (0)                                                    │   │
│   │ ──► page ──► page ──► page ──► ... (非活跃匿名页)                        │   │
│   │                                        ↑                                 │   │
│   │                                        │ 老化                            │   │
│   ├─────────────────────────────────────────────────────────────────────────┤   │
│   │ LRU_ACTIVE_ANON (1)                    │                                 │   │
│   │ ──► page ──► page ──► page ──► ... (活跃匿名页) ───────────────┐        │   │
│   │                                                                │        │   │
│   ├─────────────────────────────────────────────────────────────────────────┤   │
│   │ LRU_INACTIVE_FILE (2)                                          ↓ 新页   │   │
│   │ ──► page ──► page ──► page ──► ... (非活跃文件页)                       │   │
│   │                                        ↑                                 │   │
│   │                                        │ 老化                            │   │
│   ├─────────────────────────────────────────────────────────────────────────┤   │
│   │ LRU_ACTIVE_FILE (3)                    │                                 │   │
│   │ ──► page ──► page ──► page ──► ... (活跃文件页)                         │   │
│   │                                                                          │   │
│   ├─────────────────────────────────────────────────────────────────────────┤   │
│   │ LRU_UNEVICTABLE (4)                                                      │   │
│   │ ──► page ──► page ──► ... (不可驱逐页: mlock, ramdisk)                  │   │
│   │                                                                          │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│   页面流动:                                                                       │
│   1. 新页加入 active 链表尾部                                                    │
│   2. 再次访问设置 PG_referenced                                                  │
│   3. kswapd 扫描时:                                                              │
│      - referenced=1: 保持 active                                                │
│      - referenced=0: 移动到 inactive                                            │
│   4. 从 inactive 头部回收页面                                                    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 页面回收流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          页面回收流程                                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   触发条件                                                                        │
│   ─────────────────────────────────────────────────────────────────────────────  │
│   1. 后台回收: 空闲页 < low 水位 → kswapd 唤醒                                   │
│   2. 直接回收: 空闲页 < min 水位 → 分配者直接回收                                 │
│   3. OOM Kill: 无法回收足够页面 → 杀死进程                                       │
│                                                                                  │
│   回收流程                                                                        │
│   ─────────────────────────────────────────────────────────────────────────────  │
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                          shrink_zone()                                   │   │
│   │                               │                                          │   │
│   │              ┌────────────────┼────────────────┐                        │   │
│   │              ▼                ▼                ▼                        │   │
│   │    shrink_lruvec()    shrink_slab()     compact_zone()                  │   │
│   │         │                    │                 │                        │   │
│   │         ▼                    ▼                 │                        │   │
│   │  shrink_list()         调用 shrinker          │                        │   │
│   │  (active/inactive)      回调函数               │                        │   │
│   │                        (dentry, inode)         │                        │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│   shrink_list() 详细流程:                                                        │
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                          │   │
│   │   1. 从 inactive 链表取页面                                              │   │
│   │                 │                                                        │   │
│   │                 ▼                                                        │   │
│   │   2. 检查 page_referenced()                                              │   │
│   │         │                                                                │   │
│   │         ├── 最近被访问 → 放回 active 链表                                │   │
│   │         │                                                                │   │
│   │         └── 未被访问 → 继续回收                                          │   │
│   │                 │                                                        │   │
│   │                 ▼                                                        │   │
│   │   3. 页面类型判断                                                        │   │
│   │         │                                                                │   │
│   │         ├── 匿名页 (需要 swap)                                          │   │
│   │         │     ├── 有 swap 空间 → add_to_swap()                          │   │
│   │         │     └── 无 swap → 不可回收                                     │   │
│   │         │                                                                │   │
│   │         └── 文件页                                                       │   │
│   │               ├── dirty → pageout() 写回                                │   │
│   │               └── clean → 直接释放                                       │   │
│   │                 │                                                        │   │
│   │                 ▼                                                        │   │
│   │   4. try_to_unmap() - 解除所有映射                                       │   │
│   │                 │                                                        │   │
│   │                 ▼                                                        │   │
│   │   5. 释放页面到伙伴系统                                                  │   │
│   │                                                                          │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### OOM Killer

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          OOM Killer 机制                                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   触发: 无法分配内存且回收失败                                                    │
│                                                                                  │
│   out_of_memory()                                                               │
│         │                                                                        │
│         ▼                                                                        │
│   select_bad_process()  ←─── 选择"最坏"进程                                     │
│         │                                                                        │
│         │  评分标准 (oom_badness):                                              │
│         │  - 基础分 = 进程内存使用量 (RSS + swap)                                │
│         │  - 加权 = 基础分 * oom_score_adj / 1000                               │
│         │                                                                        │
│         │  oom_score_adj 取值:                                                  │
│         │  - -1000: 永不杀死 (OOM_SCORE_ADJ_MIN)                                │
│         │  - 0: 默认                                                            │
│         │  - +1000: 优先杀死 (OOM_SCORE_ADJ_MAX)                                │
│         │                                                                        │
│         ▼                                                                        │
│   oom_kill_process()                                                            │
│         │                                                                        │
│         ├── 发送 SIGKILL 给目标进程                                             │
│         │                                                                        │
│         └── 同时杀死共享 mm 的线程                                               │
│                                                                                  │
│   /proc/<pid>/oom_score     # 查看 OOM 评分                                     │
│   /proc/<pid>/oom_score_adj # 调整 OOM 评分 (-1000 到 1000)                     │
│   /proc/<pid>/oom_adj       # 旧接口 (-17 到 15, 已废弃)                        │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 关键源码文件

### 目录结构

```
mm/                                # 内存管理核心目录
├── page_alloc.c                   # ★ 伙伴系统实现
├── slub.c                         # ★ Slub 分配器
├── slab.c                         # Slab 分配器 (传统)
├── slob.c                         # Slob 分配器 (嵌入式)
├── vmalloc.c                      # vmalloc 实现
├── memory.c                       # ★ 页表操作、缺页处理
├── mmap.c                         # ★ mmap 实现
├── filemap.c                      # 页缓存
├── swap.c                         # 交换子系统
├── swapfile.c                     # 交换文件管理
├── vmscan.c                       # ★ 页面回收 (kswapd)
├── oom_kill.c                     # OOM 杀手
├── memblock.c                     # 启动期内存分配
├── bootmem.c                      # 启动期内存管理 (旧)
├── rmap.c                         # 反向映射
├── mremap.c                       # 地址重映射
├── mprotect.c                     # 内存保护
├── mlock.c                        # 内存锁定
├── highmem.c                      # 高端内存映射
├── hugetlb.c                      # 大页支持
├── migrate.c                      # 页面迁移
├── compaction.c                   # 内存规整
└── percpu.c                       # Per-CPU 分配器

include/linux/
├── mm.h                           # ★ 内存管理头文件
├── mm_types.h                     # ★ 核心数据结构定义
├── mmzone.h                       # ★ Zone 和节点定义
├── gfp.h                          # GFP 标志
├── slab.h                         # Slab 接口
├── slub_def.h                     # Slub 定义
├── page-flags.h                   # 页面标志
├── swap.h                         # 交换相关
└── vmalloc.h                      # vmalloc 接口

arch/x86/mm/                       # x86 架构相关
├── init.c                         # 内存初始化
├── fault.c                        # 缺页处理
├── pgtable.c                      # 页表操作
├── tlb.c                          # TLB 管理
└── highmem_32.c                   # 32位高端内存
```

### 核心函数索引

| 函数名 | 文件 | 功能 |
|--------|------|------|
| `alloc_pages()` | mm/page_alloc.c | 伙伴系统页分配入口 |
| `__alloc_pages_nodemask()` | mm/page_alloc.c | 实际分配实现 |
| `free_pages()` | mm/page_alloc.c | 页释放 |
| `kmem_cache_alloc()` | mm/slub.c | Slab 对象分配 |
| `kmalloc()` | mm/slub.c | 通用内存分配 |
| `do_page_fault()` | arch/x86/mm/fault.c | 缺页异常处理 |
| `handle_mm_fault()` | mm/memory.c | 通用缺页处理 |
| `do_mmap_pgoff()` | mm/mmap.c | mmap 核心实现 |
| `find_vma()` | mm/mmap.c | VMA 查找 |
| `shrink_zone()` | mm/vmscan.c | 页面回收 |
| `kswapd()` | mm/vmscan.c | 后台回收线程 |
| `out_of_memory()` | mm/oom_kill.c | OOM 处理入口 |

---

## 总结

Linux 3.2 内存管理系统采用多层次架构:

1. **物理内存层**: 通过 NUMA 节点 (pg_data_t) 和 Zone 组织物理内存
2. **页分配层**: 伙伴系统管理连续物理页的分配与释放
3. **对象分配层**: Slab/Slub 提供高效的小对象分配
4. **虚拟内存层**: VMA 和页表管理进程地址空间
5. **回收层**: LRU 和 kswapd 实现页面回收

核心设计思想:
- **延迟分配**: 使用缺页异常实现按需分配
- **缓存优化**: 页缓存和 Slab 缓存提高性能
- **NUMA 感知**: 优先使用本地内存
- **可伸缩性**: Per-CPU 数据结构减少锁竞争
