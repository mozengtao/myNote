#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <sys/ioctl.h>

void print_socket_buffer_sizes(int sockfd) {
    int sendbuf, recvbuf;
    socklen_t optlen = sizeof(int);
    
    getsockopt(sockfd, SOL_SOCKET, SO_SNDBUF, &sendbuf, &optlen);
    printf("å‘é€ç¼“å†²åŒºå¤§å°: %d å­—èŠ‚ (%.2f KB)\n", sendbuf, sendbuf / 1024.0);
    
    getsockopt(sockfd, SOL_SOCKET, SO_RCVBUF, &recvbuf, &optlen);
    printf("æ¥æ”¶ç¼“å†²åŒºå¤§å°: %d å­—èŠ‚ (%.2f KB)\n", recvbuf, recvbuf / 1024.0);
}

void visualize_data_flow() {
    printf("\n");
    printf("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n");
    printf("â•‘          Socket æ•°æ®ä¼ è¾“å¯è§†åŒ–æµç¨‹                            â•‘\n");
    printf("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
    printf("\n");
    printf("å‘é€æµç¨‹ï¼š\n");
    printf("  [åº”ç”¨ç¨‹åº]\n");
    printf("      â”‚ send()\n");
    printf("      â†“ ç³»ç»Ÿè°ƒç”¨ï¼ˆç”¨æˆ·æ€ â†’ å†…æ ¸æ€ï¼‰\n");
    printf("  [å†…æ ¸ Socket å‘é€ç¼“å†²åŒº]\n");
    printf("      â”‚ copy_from_user()\n");
    printf("      â†“\n");
    printf("  [TCP åè®®æ ˆå¤„ç†]\n");
    printf("      â”‚ æ·»åŠ  TCP å¤´éƒ¨ã€åˆ†æ®µ\n");
    printf("      â†“\n");
    printf("  [IP å±‚å¤„ç†]\n");
    printf("      â”‚ æ·»åŠ  IP å¤´éƒ¨ã€è·¯ç”±\n");
    printf("      â†“\n");
    printf("  [ç½‘å¡é©±åŠ¨é˜Ÿåˆ—]\n");
    printf("      â”‚ DMA ä¼ è¾“\n");
    printf("      â†“\n");
    printf("  [ç½‘å¡ç¡¬ä»¶]\n");
    printf("      â”‚\n");
    printf("      â†“ ç½‘ç»œä¼ è¾“\n");
    printf("  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
    printf("\n");
    printf("æ¥æ”¶æµç¨‹ï¼š\n");
    printf("  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
    printf("      â†‘ ç½‘ç»œä¼ è¾“\n");
    printf("      â”‚\n");
    printf("  [ç½‘å¡ç¡¬ä»¶]\n");
    printf("      â†‘ è§¦å‘ä¸­æ–­\n");
    printf("      â”‚\n");
    printf("  [ç½‘å¡é©±åŠ¨]\n");
    printf("      â†‘ DMA ä¼ è¾“\n");
    printf("      â”‚\n");
    printf("  [åè®®æ ˆå¤„ç†]\n");
    printf("      â†‘ è§£æ TCP/IP å¤´éƒ¨\n");
    printf("      â”‚\n");
    printf("  [å†…æ ¸ Socket æ¥æ”¶ç¼“å†²åŒº]\n");
    printf("      â†‘ copy_to_user()\n");
    printf("      â”‚ recv()ï¼ˆå†…æ ¸æ€ â†’ ç”¨æˆ·æ€ï¼‰\n");
    printf("  [åº”ç”¨ç¨‹åº]\n");
    printf("\n");
}

int main() {
    int sockfd;
    
    printf("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
    printf("           Linux Socket ç¼“å†²åŒºæœºåˆ¶æ¼”ç¤º\n");
    printf("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
    
    // åˆ›å»º TCP Socket
    sockfd = socket(AF_INET, SOCK_STREAM, 0);
    if (sockfd < 0) {
        perror("åˆ›å»º Socket å¤±è´¥");
        return 1;
    }
    
    printf("\nâœ… Socket åˆ›å»ºæˆåŠŸ (fd = %d)\n\n", sockfd);
    
    // æ˜¾ç¤ºé»˜è®¤ç¼“å†²åŒºå¤§å°
    printf("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n");
    printf("ğŸ“Š é»˜è®¤ Socket ç¼“å†²åŒºè®¾ç½®\n");
    printf("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n");
    print_socket_buffer_sizes(sockfd);
    
    // è®¾ç½®æ–°çš„ç¼“å†²åŒºå¤§å°
    int new_sendbuf = 256 * 1024;  // 256 KB
    int new_recvbuf = 256 * 1024;  // 256 KB
    
    printf("\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n");
    printf("ğŸ”§ è®¾ç½® Socket ç¼“å†²åŒºä¸º 256 KB\n");
    printf("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n");
    
    setsockopt(sockfd, SOL_SOCKET, SO_SNDBUF, &new_sendbuf, sizeof(new_sendbuf));
    setsockopt(sockfd, SOL_SOCKET, SO_RCVBUF, &new_recvbuf, sizeof(new_recvbuf));
    
    print_socket_buffer_sizes(sockfd);
    
    // æ˜¾ç¤ºæ•°æ®æµåŠ¨å¯è§†åŒ–
    visualize_data_flow();
    
    // æ˜¾ç¤ºå…³é”®æ¦‚å¿µ
    printf("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
    printf("ğŸ’¡ å…³é”®æ¦‚å¿µ\n");
    printf("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
    printf("\n");
    printf("1. ç”¨æˆ·æ€ vs å†…æ ¸æ€\n");
    printf("   â€¢ åº”ç”¨ç¨‹åºè¿è¡Œåœ¨ç”¨æˆ·æ€\n");
    printf("   â€¢ Socket ç¼“å†²åŒºåœ¨å†…æ ¸æ€\n");
    printf("   â€¢ éœ€è¦ç³»ç»Ÿè°ƒç”¨è¿›è¡Œæ•°æ®ä¼ é€’\n");
    printf("\n");
    printf("2. send() è¿”å› â‰  æ•°æ®å·²å‘é€\n");
    printf("   â€¢ send() è¿”å›è¡¨ç¤ºæ•°æ®å·²å¤åˆ¶åˆ°å†…æ ¸ç¼“å†²åŒº\n");
    printf("   â€¢ å®é™…ç½‘ç»œå‘é€ç”±å†…æ ¸ TCP åè®®æ ˆæ§åˆ¶\n");
    printf("   â€¢ å¯èƒ½åœ¨ç¼“å†²åŒºä¸­ç­‰å¾…ã€é‡ä¼ ç­‰\n");
    printf("\n");
    printf("3. ç¼“å†²åŒºå¤§å°å½±å“æ€§èƒ½\n");
    printf("   â€¢ è¿‡å°ï¼šé¢‘ç¹ç³»ç»Ÿè°ƒç”¨ï¼ŒCPU å¼€é”€å¤§\n");
    printf("   â€¢ è¿‡å¤§ï¼šå†…å­˜å ç”¨å¤šï¼Œå»¶è¿Ÿå¯èƒ½å¢åŠ \n");
    printf("   â€¢ éœ€è¦æ ¹æ®åº”ç”¨åœºæ™¯è°ƒä¼˜\n");
    printf("\n");
    printf("4. TCP æ»‘åŠ¨çª—å£\n");
    printf("   â€¢ æ¥æ”¶çª—å£ = æ¥æ”¶ç¼“å†²åŒºå¯ç”¨ç©ºé—´\n");
    printf("   â€¢ å‘é€çª—å£ = min(æ¥æ”¶çª—å£, æ‹¥å¡çª—å£)\n");
    printf("   â€¢ åŠ¨æ€è°ƒæ•´æµé‡æ§åˆ¶\n");
    printf("\n");
    printf("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
    printf("ğŸ“š è¯¦ç»†æ–‡æ¡£ï¼šSocketæ•°æ®ä¼ è¾“æµç¨‹.md\n");
    printf("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
    
    close(sockfd);
    return 0;
}

