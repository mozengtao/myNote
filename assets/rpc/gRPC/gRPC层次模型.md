# ğŸ—ï¸ gRPC å±‚æ¬¡æ¨¡å‹å®Œæ•´è§£æ

## ğŸ“š ç›®å½•

1. [gRPC æ•´ä½“æ¶æ„](#grpc-æ•´ä½“æ¶æ„)
2. [å››å±‚æ¶æ„æ¨¡å‹](#å››å±‚æ¶æ„æ¨¡å‹)
3. [æ•°æ®æµåŠ¨è¿‡ç¨‹](#æ•°æ®æµåŠ¨è¿‡ç¨‹)
4. [ä¸ OSI æ¨¡å‹å¯¹æ¯”](#ä¸-osi-æ¨¡å‹å¯¹æ¯”)
5. [æ ¸å¿ƒç»„ä»¶è¯¦è§£](#æ ¸å¿ƒç»„ä»¶è¯¦è§£)
6. [å®ä¾‹æ¼”ç¤º](#å®ä¾‹æ¼”ç¤º)

---

## ğŸ¯ gRPC æ•´ä½“æ¶æ„

### æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº”ç”¨å±‚ (Application)                    â”‚
â”‚           ç”¨æˆ·ä»£ç ï¼ˆä¸šåŠ¡é€»è¾‘å®ç°ï¼‰                          â”‚
â”‚    Client Stub                    Server Servicer        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   gRPC æ ¸å¿ƒå±‚ (gRPC Core)                 â”‚
â”‚         Channel, Stub, Call, Server, Interceptor        â”‚
â”‚           è´Ÿè´£æ–¹æ³•è°ƒç”¨ã€æµæ§åˆ¶ã€çŠ¶æ€ç®¡ç†                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                HTTP/2 ä¼ è¾“å±‚ (HTTP/2 Transport)           â”‚
â”‚         è¿æ¥ç®¡ç†ã€æµæ§åˆ¶ã€å¤šè·¯å¤ç”¨ã€å¤´éƒ¨å‹ç¼©                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 TCP/IP ç½‘ç»œå±‚ (TCP/IP)                    â”‚
â”‚              åº•å±‚ç½‘ç»œä¼ è¾“ã€å¯é æ€§ä¿è¯                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”· å››å±‚æ¶æ„æ¨¡å‹

### 1. åº”ç”¨å±‚ï¼ˆApplication Layerï¼‰

**èŒè´£ï¼š** ä¸šåŠ¡é€»è¾‘å®ç°

#### å®¢æˆ·ç«¯ï¼ˆClient Sideï¼‰

```python
# Stubï¼ˆå­˜æ ¹ï¼‰- è‡ªåŠ¨ç”Ÿæˆçš„å®¢æˆ·ç«¯ä»£ç 
import calculator_pb2
import calculator_pb2_grpc

# åˆ›å»º Stub
channel = grpc.insecure_channel('localhost:50051')
stub = calculator_pb2_grpc.CalculatorStub(channel)

# åº”ç”¨å±‚ä»£ç  - ä¸šåŠ¡é€»è¾‘
def calculate_sum(a, b):
    request = calculator_pb2.BinaryOperation(a=a, b=b)
    response = stub.Add(request)  # è°ƒç”¨ RPC æ–¹æ³•
    return response.value
```

**ç»„ä»¶ï¼š**
- **Client Application** - ç”¨æˆ·ä¸šåŠ¡ä»£ç 
- **Generated Stub** - è‡ªåŠ¨ç”Ÿæˆçš„å®¢æˆ·ç«¯æ¥å£
- **Request/Response Messages** - Protocol Buffer æ¶ˆæ¯

#### æœåŠ¡ç«¯ï¼ˆServer Sideï¼‰

```python
# Servicerï¼ˆæœåŠ¡å®ç°ï¼‰- ä¸šåŠ¡é€»è¾‘
class CalculatorServicer(calculator_pb2_grpc.CalculatorServicer):
    def Add(self, request, context):
        # åº”ç”¨å±‚ä¸šåŠ¡é€»è¾‘
        result = request.a + request.b
        return calculator_pb2.Result(value=result)

# æœåŠ¡æ³¨å†Œ
server = grpc.server(futures.ThreadPoolExecutor())
calculator_pb2_grpc.add_CalculatorServicer_to_server(
    CalculatorServicer(), server
)
```

**ç»„ä»¶ï¼š**
- **Server Application** - æœåŠ¡å®ç°ä»£ç 
- **Generated Servicer** - è‡ªåŠ¨ç”Ÿæˆçš„æœåŠ¡å™¨åŸºç±»
- **Business Logic** - å®é™…çš„ä¸šåŠ¡é€»è¾‘å¤„ç†

---

### 2. gRPC æ ¸å¿ƒå±‚ï¼ˆgRPC Core Layerï¼‰

**èŒè´£ï¼š** RPC è°ƒç”¨ç®¡ç†ã€æµæ§åˆ¶ã€çŠ¶æ€ç®¡ç†

#### æ ¸å¿ƒç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     gRPC Core                          â”‚
â”‚                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Channel  â”‚  â”‚  Call    â”‚  â”‚  Server  â”‚           â”‚
â”‚  â”‚  ç®¡ç†    â”‚  â”‚  è°ƒç”¨    â”‚  â”‚  æœåŠ¡å™¨  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  Stub    â”‚  â”‚Interceptorâ”‚ â”‚ Context  â”‚           â”‚
â”‚  â”‚  å­˜æ ¹    â”‚  â”‚  æ‹¦æˆªå™¨  â”‚  â”‚  ä¸Šä¸‹æ–‡  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### åŠŸèƒ½è¯¦è§£

**1. Channelï¼ˆé€šé“ï¼‰**
```python
# åˆ›å»ºé€šé“
channel = grpc.insecure_channel(
    'localhost:50051',
    options=[
        ('grpc.max_send_message_length', 50 * 1024 * 1024),
        ('grpc.max_receive_message_length', 50 * 1024 * 1024)
    ]
)
```
- ç®¡ç†å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨çš„è¿æ¥
- è´Ÿè½½å‡è¡¡
- è¿æ¥æ± ç®¡ç†
- é…ç½®ç®¡ç†

**2. Callï¼ˆè°ƒç”¨ï¼‰**
- è¡¨ç¤ºä¸€æ¬¡ RPC è°ƒç”¨
- ç®¡ç†è¯·æ±‚/å“åº”çš„ç”Ÿå‘½å‘¨æœŸ
- è¶…æ—¶æ§åˆ¶
- å–æ¶ˆæœºåˆ¶

**3. Serverï¼ˆæœåŠ¡å™¨ï¼‰**
```python
server = grpc.server(
    futures.ThreadPoolExecutor(max_workers=10),
    options=[
        ('grpc.max_send_message_length', 50 * 1024 * 1024)
    ]
)
```
- ç›‘å¬å’Œæ¥å—è¿æ¥
- è¯·æ±‚è·¯ç”±
- çº¿ç¨‹æ± ç®¡ç†
- æœåŠ¡æ³¨å†Œ

**4. Interceptorï¼ˆæ‹¦æˆªå™¨ï¼‰**
```python
class AuthInterceptor(grpc.ServerInterceptor):
    def intercept_service(self, continuation, handler_call_details):
        # è®¤è¯é€»è¾‘
        metadata = dict(handler_call_details.invocation_metadata)
        if 'authorization' not in metadata:
            context.abort(grpc.StatusCode.UNAUTHENTICATED, 'Missing auth')
        return continuation(handler_call_details)
```
- è¯·æ±‚/å“åº”æ‹¦æˆª
- è®¤è¯æˆæƒ
- æ—¥å¿—è®°å½•
- ç›‘æ§ç»Ÿè®¡

**5. Contextï¼ˆä¸Šä¸‹æ–‡ï¼‰**
```python
def MyMethod(self, request, context):
    # è®¿é—®å…ƒæ•°æ®
    metadata = dict(context.invocation_metadata())
    
    # è®¾ç½®å“åº”å…ƒæ•°æ®
    context.set_trailing_metadata([('key', 'value')])
    
    # æ£€æŸ¥æ˜¯å¦å–æ¶ˆ
    if context.is_active():
        return response
```
- æºå¸¦å…ƒæ•°æ®
- è¶…æ—¶ç®¡ç†
- å–æ¶ˆä¿¡å·
- çŠ¶æ€ç è®¾ç½®

---

### 3. HTTP/2 ä¼ è¾“å±‚ï¼ˆHTTP/2 Transport Layerï¼‰

**èŒè´£ï¼š** ç½‘ç»œä¼ è¾“ã€æµæ§åˆ¶ã€å¤šè·¯å¤ç”¨

#### HTTP/2 ç‰¹æ€§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   HTTP/2 å±‚                           â”‚
â”‚                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ å¤šè·¯å¤ç”¨    â”‚  â”‚  æµæ§åˆ¶    â”‚  â”‚ å¤´éƒ¨å‹ç¼©    â”‚    â”‚
â”‚  â”‚Multiplexingâ”‚  â”‚Flow Controlâ”‚  â”‚HPACK       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ æœåŠ¡å™¨æ¨é€  â”‚  â”‚ äºŒè¿›åˆ¶å¸§    â”‚  â”‚ ä¼˜å…ˆçº§      â”‚    â”‚
â”‚  â”‚Server Push â”‚  â”‚Binary Frameâ”‚  â”‚Priority    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ç‰¹æ€§è¯¦è§£

**1. å¤šè·¯å¤ç”¨ï¼ˆMultiplexingï¼‰**
```
å•ä¸ª TCP è¿æ¥ä¸Šçš„å¤šä¸ª RPC è°ƒç”¨ï¼š

Stream 1: Add(5, 10)      â”€â”€â”
Stream 3: Multiply(3, 4)  â”€â”€â”¼â”€â”€â†’ åŒä¸€ä¸ª TCP è¿æ¥
Stream 5: Divide(20, 5)   â”€â”€â”˜
```
- ä¸€ä¸ªè¿æ¥ä¸Šå¹¶å‘å¤šä¸ªè¯·æ±‚
- æ¶ˆé™¤é˜Ÿå¤´é˜»å¡
- æé«˜è¿æ¥åˆ©ç”¨ç‡

**2. æµæ§åˆ¶ï¼ˆFlow Controlï¼‰**
- é˜²æ­¢å‘é€æ–¹å‹å®æ¥æ”¶æ–¹
- çª—å£å¤§å°æ§åˆ¶
- èƒŒå‹æœºåˆ¶ï¼ˆBackpressureï¼‰

**3. å¤´éƒ¨å‹ç¼©ï¼ˆHPACKï¼‰**
```
åŸå§‹å¤´éƒ¨ï¼š
:method: POST
:path: /Calculator/Add
:authority: localhost:50051
content-type: application/grpc+proto
...

å‹ç¼©åï¼šçº¦ 70% ä½“ç§¯å‡å°‘
```

**4. äºŒè¿›åˆ¶å¸§ï¼ˆBinary Framingï¼‰**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Frame Header (9 bytes)   â”‚
â”‚  Length | Type | Flags | ... â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      Frame Payload           â”‚
â”‚      (å˜é•¿)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
- DATA å¸§ - ä¼ è¾“æ•°æ®
- HEADERS å¸§ - ä¼ è¾“å¤´éƒ¨
- SETTINGS å¸§ - è¿æ¥é…ç½®
- WINDOW_UPDATE å¸§ - æµæ§åˆ¶

---

### 4. TCP/IP ç½‘ç»œå±‚ï¼ˆTCP/IP Layerï¼‰

**èŒè´£ï¼š** åº•å±‚ç½‘ç»œä¼ è¾“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           TCP/IP å±‚                   â”‚
â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   TCP    â”‚  â”‚   IP     â”‚         â”‚
â”‚  â”‚ å¯é ä¼ è¾“  â”‚  â”‚  è·¯ç”±    â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- TCP è¿æ¥ç®¡ç†
- ä¸‰æ¬¡æ¡æ‰‹
- å¯é ä¼ è¾“ï¼ˆé‡ä¼ ã€é¡ºåºï¼‰
- IP è·¯ç”±

---

## ğŸ”„ æ•°æ®æµåŠ¨è¿‡ç¨‹

### å®¢æˆ·ç«¯è¯·æ±‚æµç¨‹

```
[1] åº”ç”¨å±‚
    â†“ åˆ›å»ºè¯·æ±‚å¯¹è±¡
    request = BinaryOperation(a=5, b=10)
    
[2] gRPC æ ¸å¿ƒå±‚
    â†“ åºåˆ—åŒ–ä¸º Protocol Buffer
    bytes = request.SerializeToString()
    â†“ æ·»åŠ  gRPC å…ƒæ•°æ®ï¼ˆæ–¹æ³•åã€è¶…æ—¶ç­‰ï¼‰
    metadata = {':path': '/Calculator/Add', ...}
    
[3] HTTP/2 å±‚
    â†“ åˆ†å‰²ä¸º HTTP/2 å¸§
    HEADERS frame: [metadata]
    DATA frame: [serialized bytes]
    â†“ å‹ç¼©å¤´éƒ¨ï¼ˆHPACKï¼‰
    â†“ å¤šè·¯å¤ç”¨ï¼ˆStream ID: 1ï¼‰
    
[4] TCP/IP å±‚
    â†“ å‘é€ TCP æ•°æ®åŒ…
    [network transmission]
```

### æœåŠ¡ç«¯å“åº”æµç¨‹

```
[4] TCP/IP å±‚
    â†‘ æ¥æ”¶ TCP æ•°æ®åŒ…
    
[3] HTTP/2 å±‚
    â†‘ è§£æ HTTP/2 å¸§
    â†‘ è§£å‹å¤´éƒ¨ï¼ˆHPACKï¼‰
    â†‘ é‡ç»„æ•°æ®
    
[2] gRPC æ ¸å¿ƒå±‚
    â†‘ æå–å…ƒæ•°æ®å’Œæ–¹æ³•å
    â†‘ ååºåˆ—åŒ– Protocol Buffer
    request = BinaryOperation.ParseFromString(bytes)
    â†‘ è·¯ç”±åˆ°å¯¹åº”çš„ Servicer æ–¹æ³•
    
[1] åº”ç”¨å±‚
    â†‘ æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    result = request.a + request.b
    â†‘ åˆ›å»ºå“åº”å¯¹è±¡
    return Result(value=result)
```

---

## ğŸ†š ä¸ OSI æ¨¡å‹å¯¹æ¯”

### OSI ä¸ƒå±‚æ¨¡å‹ vs gRPC æ¨¡å‹

```
OSI æ¨¡å‹                     gRPC æ¨¡å‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
7. åº”ç”¨å±‚                    åº”ç”¨å±‚
   (Application)             (User Code + Stub)
                             â†‘
6. è¡¨ç¤ºå±‚                    gRPC æ ¸å¿ƒå±‚
   (Presentation)            (Serialization)
                             â†‘
5. ä¼šè¯å±‚                    gRPC æ ¸å¿ƒå±‚
   (Session)                 (Call Management)
                             â†‘
4. ä¼ è¾“å±‚                    HTTP/2 å±‚
   (Transport)               (Stream Control)
                             â†‘
3. ç½‘ç»œå±‚                    TCP/IP
   (Network)                 
                             â†‘
2. æ•°æ®é“¾è·¯å±‚                TCP/IP
   (Data Link)               
                             â†‘
1. ç‰©ç†å±‚                    TCP/IP
   (Physical)                
```

### å¯¹åº”å…³ç³»

| OSI å±‚ | gRPC å±‚ | åŠŸèƒ½ |
|--------|---------|------|
| 7 åº”ç”¨å±‚ | åº”ç”¨å±‚ | ä¸šåŠ¡é€»è¾‘å®ç° |
| 6 è¡¨ç¤ºå±‚ | gRPC æ ¸å¿ƒ | Protocol Buffer åºåˆ—åŒ– |
| 5 ä¼šè¯å±‚ | gRPC æ ¸å¿ƒ | RPC è°ƒç”¨ç®¡ç† |
| 4 ä¼ è¾“å±‚ | HTTP/2 | å¯é ä¼ è¾“ã€æµæ§åˆ¶ |
| 3-1 ç½‘ç»œå±‚ | TCP/IP | ç½‘ç»œä¼ è¾“ |

---

## ğŸ”§ æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. Channelï¼ˆé€šé“ï¼‰æ¶æ„

```
Channel
â”œâ”€â”€ SubChannel (å­é€šé“)
â”‚   â”œâ”€â”€ Connection 1
â”‚   â””â”€â”€ Connection 2
â”œâ”€â”€ Load Balancer (è´Ÿè½½å‡è¡¡å™¨)
â”‚   â”œâ”€â”€ Pick First
â”‚   â”œâ”€â”€ Round Robin
â”‚   â””â”€â”€ Custom
â”œâ”€â”€ Name Resolver (åç§°è§£æå™¨)
â”‚   â”œâ”€â”€ DNS
â”‚   â”œâ”€â”€ Static
â”‚   â””â”€â”€ Custom
â””â”€â”€ Interceptors (æ‹¦æˆªå™¨é“¾)
    â”œâ”€â”€ Logging
    â”œâ”€â”€ Retry
    â””â”€â”€ Auth
```

### 2. Callï¼ˆè°ƒç”¨ï¼‰ç”Ÿå‘½å‘¨æœŸ

```
[åˆ›å»º] â†’ [åˆå§‹åŒ–] â†’ [å‘é€è¯·æ±‚] â†’ [ç­‰å¾…å“åº”] â†’ [æ¥æ”¶å“åº”] â†’ [å®Œæˆ/é”™è¯¯]
   â†“        â†“          â†“           â†“            â†“            â†“
  NEW   STARTING   SENDING    RECEIVING      CLOSING      DONE
                                                          /ERROR
```

### 3. Serverï¼ˆæœåŠ¡å™¨ï¼‰æ¶æ„

```
Server
â”œâ”€â”€ Transport (ä¼ è¾“å±‚)
â”‚   â”œâ”€â”€ TCP Listener
â”‚   â””â”€â”€ HTTP/2 Handler
â”œâ”€â”€ Thread Pool (çº¿ç¨‹æ± )
â”‚   â”œâ”€â”€ Worker Thread 1
â”‚   â”œâ”€â”€ Worker Thread 2
â”‚   â””â”€â”€ Worker Thread N
â”œâ”€â”€ Service Registry (æœåŠ¡æ³¨å†Œè¡¨)
â”‚   â”œâ”€â”€ Service 1
â”‚   â”‚   â”œâ”€â”€ Method A
â”‚   â”‚   â””â”€â”€ Method B
â”‚   â””â”€â”€ Service 2
â”œâ”€â”€ Interceptors (æ‹¦æˆªå™¨)
â””â”€â”€ Health Check (å¥åº·æ£€æŸ¥)
```

---

## ğŸ’» å®ä¾‹æ¼”ç¤º

### å®Œæ•´çš„å±‚æ¬¡è°ƒç”¨ç¤ºä¾‹

```python
# ==================== 1. åº”ç”¨å±‚ ====================

# å®¢æˆ·ç«¯åº”ç”¨ä»£ç 
class MyClient:
    def __init__(self):
        # 2. gRPC æ ¸å¿ƒå±‚ï¼šåˆ›å»º Channel
        self.channel = grpc.insecure_channel(
            'localhost:50051',
            options=[
                ('grpc.keepalive_time_ms', 10000),
                ('grpc.keepalive_timeout_ms', 5000)
            ]
        )
        # åˆ›å»º Stub
        self.stub = calculator_pb2_grpc.CalculatorStub(self.channel)
    
    def calculate(self, a, b):
        # 1. åº”ç”¨å±‚ï¼šåˆ›å»ºè¯·æ±‚
        request = calculator_pb2.BinaryOperation(a=a, b=b)
        
        # 2. gRPC æ ¸å¿ƒå±‚ï¼šæ·»åŠ å…ƒæ•°æ®
        metadata = [
            ('authorization', 'Bearer token123'),
            ('client-id', 'python-client')
        ]
        
        try:
            # å‘èµ·è°ƒç”¨ï¼ˆç»è¿‡æ‰€æœ‰å±‚æ¬¡ï¼‰
            response = self.stub.Add(
                request,
                metadata=metadata,
                timeout=5.0  # è¶…æ—¶è®¾ç½®
            )
            return response.value
            
        except grpc.RpcError as e:
            # é”™è¯¯å¤„ç†
            print(f"RPC å¤±è´¥: {e.code()}")
            print(f"è¯¦æƒ…: {e.details()}")


# æœåŠ¡ç«¯åº”ç”¨ä»£ç 
class CalculatorServicer(calculator_pb2_grpc.CalculatorServicer):
    
    def Add(self, request, context):
        # 1. åº”ç”¨å±‚ï¼šè®¿é—®è¯·æ±‚æ•°æ®
        print(f"æ”¶åˆ°è¯·æ±‚: {request.a} + {request.b}")
        
        # 2. gRPC æ ¸å¿ƒå±‚ï¼šè®¿é—®ä¸Šä¸‹æ–‡
        metadata = dict(context.invocation_metadata())
        print(f"å®¢æˆ·ç«¯ ID: {metadata.get('client-id')}")
        
        # éªŒè¯æˆæƒ
        if 'authorization' not in metadata:
            context.abort(
                grpc.StatusCode.UNAUTHENTICATED,
                'ç¼ºå°‘è®¤è¯ä¿¡æ¯'
            )
        
        # 1. åº”ç”¨å±‚ï¼šä¸šåŠ¡é€»è¾‘
        result = request.a + request.b
        
        # 2. gRPC æ ¸å¿ƒå±‚ï¼šè®¾ç½®å“åº”å…ƒæ•°æ®
        context.set_trailing_metadata([
            ('server-version', '1.0.0'),
            ('processing-time', '0.001s')
        ])
        
        # è¿”å›å“åº”
        return calculator_pb2.Result(value=result)


# å¯åŠ¨æœåŠ¡å™¨
def serve():
    # 2. gRPC æ ¸å¿ƒå±‚ï¼šåˆ›å»º Server
    server = grpc.server(
        futures.ThreadPoolExecutor(max_workers=10),
        options=[
            ('grpc.max_send_message_length', 10 * 1024 * 1024),
            ('grpc.max_receive_message_length', 10 * 1024 * 1024)
        ]
    )
    
    # æ³¨å†ŒæœåŠ¡
    calculator_pb2_grpc.add_CalculatorServicer_to_server(
        CalculatorServicer(), server
    )
    
    # 3. HTTP/2 å±‚ï¼šç›‘å¬ç«¯å£
    server.add_insecure_port('[::]:50051')
    
    # å¯åŠ¨ï¼ˆæ¶‰åŠæ‰€æœ‰å±‚æ¬¡ï¼‰
    server.start()
    server.wait_for_termination()
```

### æ‹¦æˆªå™¨ç¤ºä¾‹ï¼ˆgRPC æ ¸å¿ƒå±‚ï¼‰

```python
# å®¢æˆ·ç«¯æ‹¦æˆªå™¨
class ClientInterceptor(grpc.UnaryUnaryClientInterceptor):
    def intercept_unary_unary(self, continuation, client_call_details, request):
        print("[æ‹¦æˆªå™¨] è¯·æ±‚å‰å¤„ç†")
        print(f"  æ–¹æ³•: {client_call_details.method}")
        print(f"  è¯·æ±‚: {request}")
        
        # ä¿®æ”¹å…ƒæ•°æ®
        metadata = list(client_call_details.metadata or [])
        metadata.append(('x-request-id', str(uuid.uuid4())))
        
        # åˆ›å»ºæ–°çš„è°ƒç”¨è¯¦æƒ…
        new_details = grpc.ClientCallDetails(
            client_call_details.method,
            client_call_details.timeout,
            metadata,
            client_call_details.credentials
        )
        
        # ç»§ç»­è°ƒç”¨
        response = continuation(new_details, request)
        
        print("[æ‹¦æˆªå™¨] å“åº”åå¤„ç†")
        print(f"  å“åº”: {response}")
        
        return response


# æœåŠ¡ç«¯æ‹¦æˆªå™¨
class ServerInterceptor(grpc.ServerInterceptor):
    def intercept_service(self, continuation, handler_call_details):
        print("[æ‹¦æˆªå™¨] æœåŠ¡ç«¯æ¥æ”¶è¯·æ±‚")
        print(f"  æ–¹æ³•: {handler_call_details.method}")
        
        # è·å–å…ƒæ•°æ®
        metadata = dict(handler_call_details.invocation_metadata)
        request_id = metadata.get('x-request-id', 'unknown')
        print(f"  è¯·æ±‚ ID: {request_id}")
        
        # ç»§ç»­å¤„ç†
        return continuation(handler_call_details)
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–ä¸å±‚æ¬¡å…³ç³»

### å„å±‚ä¼˜åŒ–ç­–ç•¥

| å±‚æ¬¡ | ä¼˜åŒ–ç­–ç•¥ | å½±å“ |
|------|---------|------|
| **åº”ç”¨å±‚** | å‡å°‘æ¶ˆæ¯å¤§å°ã€æ‰¹é‡å¤„ç† | CPUã€å†…å­˜ |
| **gRPC æ ¸å¿ƒ** | è¿æ¥æ± ã€æ‹¦æˆªå™¨ä¼˜åŒ– | å»¶è¿Ÿã€ååé‡ |
| **HTTP/2** | æµæ§åˆ¶ã€å¤šè·¯å¤ç”¨ | ç½‘ç»œæ•ˆç‡ |
| **TCP/IP** | TCP å‚æ•°è°ƒä¼˜ | å¸¦å®½åˆ©ç”¨ç‡ |

---

## âœ¨ æ€»ç»“

### gRPC å››å±‚æ¨¡å‹

1. **åº”ç”¨å±‚** - ä¸šåŠ¡é€»è¾‘ã€Stub/Servicer
2. **gRPC æ ¸å¿ƒå±‚** - RPC ç®¡ç†ã€åºåˆ—åŒ–ã€æ‹¦æˆªå™¨
3. **HTTP/2 å±‚** - ä¼ è¾“åè®®ã€æµæ§åˆ¶ã€å¤šè·¯å¤ç”¨
4. **TCP/IP å±‚** - ç½‘ç»œä¼ è¾“ã€å¯é æ€§

### å…³é”®ä¼˜åŠ¿

- âœ… **æ¸…æ™°çš„å±‚æ¬¡åˆ†ç¦»** - æ¯å±‚èŒè´£æ˜ç¡®
- âœ… **Protocol Buffers** - é«˜æ•ˆåºåˆ—åŒ–ï¼ˆè¡¨ç¤ºå±‚ï¼‰
- âœ… **HTTP/2** - ç°ä»£ä¼ è¾“åè®®ï¼ˆä¼šè¯/ä¼ è¾“å±‚ï¼‰
- âœ… **å¯æ‰©å±•æ€§** - æ‹¦æˆªå™¨ã€æ’ä»¶æœºåˆ¶

### ç†è§£è¦ç‚¹

1. æ•°æ®ä»åº”ç”¨å±‚é€å±‚å‘ä¸‹ä¼ é€’åˆ°ç½‘ç»œå±‚
2. æ¯ä¸€å±‚éƒ½æ·»åŠ è‡ªå·±çš„å¤´éƒ¨ä¿¡æ¯
3. HTTP/2 æä¾›äº†å…³é”®çš„æ€§èƒ½ä¼˜åŠ¿
4. gRPC æ ¸å¿ƒå±‚è´Ÿè´£ RPC è¯­ä¹‰çš„å®ç°

**æŒæ¡å±‚æ¬¡æ¨¡å‹ï¼Œæ›´å¥½åœ°ç†è§£å’Œä¼˜åŒ– gRPC åº”ç”¨ï¼** ğŸš€

